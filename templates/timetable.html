{% extends 'base.html' %}

{% block title %}RadIMO Cortex | Timetable{% endblock %}

{% block styles %}
    :root {
      --disabled-color: #888;
      --primary-color: #004892;
      --global-accent: #004892;
      --body-bg: #f0f0f0;
      --header-bg: #fff;
      --tab-bg: #fff;
      --tab-color: #000;
      --card-bg: #fff;
      --timeline-start: 6;
      /* 6:00 */
      --timeline-end: 20;
      /* 20:00 */
      --timeline-hours: 14;
      /* 20 - 6 */
      --worker-col-width: 180px;
      /* Width of worker name column */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 1rem;
      max-width: 1800px;
      margin: 0 auto;
    }

    body[data-modality] {
      background: var(--modality-bg, var(--body-bg));
    }

    /* Filter bars */
    .skill-filter-bar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
    }

    .skill-filter-bar label {
      font-weight: 600;
      margin-right: 0.5rem;
      color: var(--text-dark, #333);
    }

    .filter-btn {
      padding: 0.4rem 1rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      background: white;
      color: #333;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .filter-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .filter-btn.active {
      background: #004892;
      color: white;
      border-color: #004892;
    }

    /* Timeline container */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .timeline-wrapper {
      overflow-x: auto;
      overflow-y: visible;
    }

    .timeline-grid {
      display: grid;
      grid-template-columns: var(--worker-col-width) 1fr;
      min-width: 800px;
    }

    /* Time header */
    .time-header {
      grid-column: 2;
      display: flex;
      border-bottom: 2px solid #ddd;
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .time-header-label {
      grid-column: 1;
      background: #f8f9fa;
      border-bottom: 2px solid #ddd;
      padding: 0.5rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      left: 0;
      z-index: 11;
    }

    .time-slot {
      flex: 1;
      text-align: center;
      padding: 0.5rem 0;
      font-size: 0.75rem;
      color: #666;
      border-left: 1px solid #eee;
    }

    .time-slot:first-child {
      border-left: none;
    }

    /* Worker rows */
    .worker-row {
      display: contents;
    }

    .worker-name-cell {
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 500;
      background: #fff;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      position: sticky;
      left: 0;
      z-index: 5;
      min-height: 36px;
      transition: opacity 0.15s ease-in-out;
    }

    .worker-timeline {
      position: relative;
      height: 36px;
      background: linear-gradient(90deg,
          transparent calc(100% / 14 * 0), #f0f0f0 calc(100% / 14 * 0), #f0f0f0 calc(100% / 14 * 0 + 1px),
          transparent calc(100% / 14 * 1), #f0f0f0 calc(100% / 14 * 1), #f0f0f0 calc(100% / 14 * 1 + 1px),
          transparent calc(100% / 14 * 2), #f0f0f0 calc(100% / 14 * 2), #f0f0f0 calc(100% / 14 * 2 + 1px),
          transparent calc(100% / 14 * 3), #f0f0f0 calc(100% / 14 * 3), #f0f0f0 calc(100% / 14 * 3 + 1px),
          transparent calc(100% / 14 * 4), #f0f0f0 calc(100% / 14 * 4), #f0f0f0 calc(100% / 14 * 4 + 1px),
          transparent calc(100% / 14 * 5), #f0f0f0 calc(100% / 14 * 5), #f0f0f0 calc(100% / 14 * 5 + 1px),
          transparent calc(100% / 14 * 6), #f0f0f0 calc(100% / 14 * 6), #f0f0f0 calc(100% / 14 * 6 + 1px),
          transparent calc(100% / 14 * 7), #f0f0f0 calc(100% / 14 * 7), #f0f0f0 calc(100% / 14 * 7 + 1px),
          transparent calc(100% / 14 * 8), #f0f0f0 calc(100% / 14 * 8), #f0f0f0 calc(100% / 14 * 8 + 1px),
          transparent calc(100% / 14 * 9), #f0f0f0 calc(100% / 14 * 9), #f0f0f0 calc(100% / 14 * 9 + 1px),
          transparent calc(100% / 14 * 10), #f0f0f0 calc(100% / 14 * 10), #f0f0f0 calc(100% / 14 * 10 + 1px),
          transparent calc(100% / 14 * 11), #f0f0f0 calc(100% / 14 * 11), #f0f0f0 calc(100% / 14 * 11 + 1px),
          transparent calc(100% / 14 * 12), #f0f0f0 calc(100% / 14 * 12), #f0f0f0 calc(100% / 14 * 12 + 1px),
          transparent calc(100% / 14 * 13), #f0f0f0 calc(100% / 14 * 13), #f0f0f0 calc(100% / 14 * 13 + 1px),
          transparent 100%);
      border-bottom: 1px solid #eee;
      transition: opacity 0.15s ease-in-out;
    }

    /* Shift bars */
    .shift-bar {
      position: absolute;
      top: 4px;
      height: 28px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      cursor: default;
      overflow: hidden;
      transition: opacity 0.15s;
    }

    .shift-bar:hover {
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Gap bars */
    .gap-bar {
      position: absolute;
      top: 8px;
      height: 20px;
      border-radius: 3px;
      cursor: default;
      overflow: hidden;
      transition: opacity 0.15s;
      background: repeating-linear-gradient(
        45deg,
        #9e9e9e,
        #9e9e9e 4px,
        #bdbdbd 4px,
        #bdbdbd 8px
      );
      border: 1px dashed #757575;
      opacity: 0.85;
    }

    .gap-bar:hover {
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      opacity: 1;
    }

    /* Tooltip */
    .shift-bar[title] {
      position: relative;
    }

    /* Current time indicator - contained within timeline grid */
    .timeline-grid {
      position: relative;
    }

    .current-time-line {
      position: absolute;
      top: 32px;
      /* Below header */
      bottom: 0;
      width: 2px;
      background: #dc3545;
      z-index: 8;
      pointer-events: none;
    }

    .current-time-line::before {
      content: '';
      position: absolute;
      top: 0;
      left: -4px;
      width: 10px;
      height: 10px;
      background: #dc3545;
      border-radius: 50%;
    }


    /* Legend */
    .legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .legend-box.legend-gap {
      background: repeating-linear-gradient(
        45deg,
        #9e9e9e,
        #9e9e9e 4px,
        #bdbdbd 4px,
        #bdbdbd 8px
      );
      border: 1px dashed #757575;
    }

    /* Back button */
    .back-button {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: #004892;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 1rem;
      transition: background 0.2s;
    }

    .back-button:hover {
      background: #003670;
    }

    /* Empty state */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 1rem;
      color: #666;
      font-size: 1.1rem;
    }

{% endblock %}

{% block body_attrs %} data-modality="{{ modality }}"{% endblock %}

{% block content %}
  {% set header_title = 'RadIMO Cortex | Timetable' %}
  {% set header_subtitle = 'Intelligent Radiology Orchestration' %}
  {% set header_mode = 'global' %}
  {% if is_admin %}
    {% set header_links = [
      {'href': url_for('routes.worker_load_monitor'), 'label': 'Worker Load'},
      {'href': url_for('routes.skill_roster_page'), 'label': 'Skill Matrix'},
      {'href': url_for('routes.prep_next_day'), 'label': 'Schedule Edit'},
      {'href': url_for('routes.upload_file', modality=modality), 'label': 'Upload'},
      {'href': url_for('routes.logout'), 'label': 'Logout', 'accent': True},
      {'href': url_for('routes.timetable', modality='all'), 'label': 'Timetable', 'active': True},
      {'href': url_for('routes.index', modality=modality), 'label': 'Dashboard'}
    ] %}
  {% else %}
    {% set header_links = [
      {'href': url_for('routes.upload_file', modality=modality), 'label': 'Admin', 'accent': True},
      {'href': url_for('routes.timetable', modality='all'), 'label': 'Timetable', 'active': True},
      {'href': url_for('routes.index', modality=modality), 'label': 'Dashboard'}
    ] %}
  {% endif %}
  {% include 'partials/header.html' %}

  <!-- Modality Filter Bar -->
  <div class="skill-filter-bar" id="modalityFilterBar">
    <label>Modality:</label>
    <a href="#" class="filter-btn {% if modality == 'all' %}active{% endif %}" data-modality="all"
      onclick="changeModality(event, 'all')">ALL</a>
    {% for mod in modality_order %}
    <a href="#" class="filter-btn {% if modality == mod %}active{% endif %}" data-modality="{{ mod }}"
      onclick="changeModality(event, '{{ mod }}')">
      {{ modality_labels[mod] }}
    </a>
    {% endfor %}
  </div>

  <!-- Skill Filter Bar -->
  <div class="skill-filter-bar" id="skillFilterBar">
    <label>Filter by Skill:</label>
    <button class="filter-btn {% if skill_filter == 'all' %}active{% endif %}" data-skill="all"
      onclick="filterBySkill('all')">All</button>
    {% for skill in skill_definitions %}
    <button class="filter-btn {% if skill_filter == skill.slug %}active{% endif %}" data-skill="{{ skill.slug }}"
      onclick="filterBySkill('{{ skill.slug }}')">
      {{ skill.label }}
    </button>
    {% endfor %}
  </div>

  <div class="card">
    <div class="timeline-wrapper">
      <div id="timeline-grid" class="timeline-grid" data-filter="all">
        <!-- Time header label -->
        <div class="time-header-label">Worker</div>
        <!-- Time header row -->
        <div class="time-header" id="time-header"></div>
        <!-- Worker rows inserted here by JS -->
      </div>
    </div>
    <div class="legend">
      {% for skill in skill_definitions %}
      <div class="legend-item">
        <div class="legend-box" data-skill="{{ skill.slug }}"></div> {{ skill.label }}
      </div>
      {% endfor %}
      <div class="legend-item">
        <div class="legend-box legend-gap"></div> Pause/Gap
      </div>
    </div>
  </div>

  <a href="{{ url_for('routes.index', modality=modality) }}" class="back-button">Zur√ºck zur Hauptseite</a>

  <!-- Shared timeline module -->
  <script src="{{ url_for('static', filename='js/timeline.js') }}"></script>
  <!-- Timetable page JS -->
  <script src="{{ url_for('static', filename='js/timetable.js') }}"></script>
  <!-- Page configuration with Jinja data -->
  <script>
    initTimetableConfig({
      modalities: {{ modalities|tojson|safe }},
      skillDefinitions: {{ skill_definitions|tojson|safe }},
      skillColumns: {{ skill_columns|tojson|safe }},
      skillSlugMap: {{ skill_slug_map|tojson|safe }},
      skillColorMap: {{ skill_color_map|tojson|safe }},
      modColorMap: {{ modality_color_map|tojson|safe }},
      currentModality: '{{ modality }}',
      skillFilter: '{{ skill_filter }}',
      data: {{ debug_data|safe }}
    });
  </script>
{% endblock %}
