<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zeitplan - {{ modality_labels[modality] }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='vis.min.css') }}">
  <style>
    :root {
      --disabled-color:  #888;

      /* Global & Other Colors */
      --primary-color:   #004892;
      --global-accent:   #004892;
      --body-bg:         #f0f0f0;
      --header-bg:       #fff;
      --tab-bg:          #fff;
      --tab-color:       #000;
      --card-bg:         #fff;
      --info-box-border: #dc3545;
      --info-item-bg:    #fff;
      --info-item-shadow: rgba(0, 0, 0, 0.05);
      --card-header-bg:  #f8f9fa;
      --stats-header-bg: #f8f9fa;
      --table-header-bg: #f8f9fa;
      --highlight-bg:    rgba(0, 0, 0, 0.05);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 1rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Background based on modality */
    body[data-modality] {
      background: var(--modality-bg, var(--body-bg));
    }

    {% for key, settings in modalities.items() %}
    body[data-modality="{{ key }}"] {
      --modality-bg: {{ settings.background_color }};
      --modality-nav: {{ settings.nav_color }};
      --modality-hover: {{ settings.hover_color }};
    }
    {% endfor %}
    /* Premium header mimicking the admin page */
    .premium-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--header-bg);
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .premium-header h1 {
      font-size: 1.75rem;
      margin: 0;
    }
    .modality-selector {
      display: flex;
      gap: 1rem;
    }
    .modality-selector a {
      text-decoration: none;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      background: var(--tab-bg);
      color: var(--tab-color);
      border: 2px solid;
      transition: border-width 0.2s;
    }
    {% for key, settings in modalities.items() %}
    .modality-selector a[data-modality="{{ key }}"] {
      border-color: {{ settings.nav_color }};
    }
    {% endfor %}
    .modality-selector a.active {
      border-width: 4px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .timeline-card {
      margin-bottom: 1rem;
    }
    #timeline-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      background: #fff;
      min-height: 150px;
    }
    .legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }
    .legend-box {
      width: 15px;
      height: 15px;
      margin-right: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    /* Back button similar to admin page style */
    .back-button {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      font-size: 1rem;
      margin-top: 1rem;
      background: var(--modality-nav, var(--primary-color));
      transition: background 0.3s;
    }
    .back-button:hover {
      background: var(--modality-hover, #003f73);
    }
  </style>
</head>
<body data-modality="{{ modality }}">
  <header class="premium-header">
    <h1>Zeitplan - {{ modality_labels[modality] }}</h1>
    <div class="modality-selector">
      {% for mod in modality_order %}
        <a href="{{ url_for('timetable', modality=mod) }}" data-modality="{{ mod }}" class="{% if modality == mod %}active{% endif %}">{{ modality_labels[mod] }}</a>
      {% endfor %}
    </div>
  </header>
  
  <div class="card timeline-card">
    <div id="timeline-container"></div>
    <div class="legend">
      {% for skill in skill_definitions %}
        <div class="legend-item">
          <div class="legend-box" style="background: {{ skill.button_color }};"></div> {{ skill.label }}
        </div>
      {% endfor %}
    </div>
  </div>
  
  <a href="{{ url_for('index', modality=modality) }}" class="back-button">Zur√ºck zur Hauptseite</a>
  
  <script src="{{ url_for('static', filename='vis.min.js') }}"></script>
  <script>
    const skillColumns = {{ skill_columns|tojson }};
    const skillSlugMap = {{ skill_slug_map|tojson }};
    const skillColorMap = {{ skill_color_map|tojson }};

    function buildGradient(skills) {
      const stripeWidth = 10;
      const gapWidth = 15;
      if (!skills || skills.length === 0) {
        return "background: #ffffff;";
      }
      const colors = skills.map(slug => skillColorMap[slug] || '#cccccc');
      if (colors.length === 1) {
        const color = colors[0];
        return `background: repeating-linear-gradient(
          90deg,
          ${color} 0px,
          ${color} ${stripeWidth}px,
          #ffffff ${stripeWidth}px,
          #ffffff ${stripeWidth + gapWidth}px
        );`;
      }
      const stops = colors.map((color, idx) => {
        const start = idx * stripeWidth;
        const end = start + stripeWidth;
        return `${color} ${start}px, ${color} ${end}px`;
      });
      const blockWidth = colors.length * stripeWidth;
      stops.push(`#ffffff ${blockWidth}px, #ffffff ${blockWidth + gapWidth}px`);
      const period = blockWidth + gapWidth;
      return `background: repeating-linear-gradient(90deg, ${stops.join(', ')}, #ffffff ${period}px);`;
    }
    
    function buildTimeline() {
      const timelineContainer = document.getElementById('timeline-container');
      let dfData;
      try {
        dfData = JSON.parse('{{ debug_data|safe }}');
      } catch (e) {
        console.error("Failed to parse timeline data:", e);
        timelineContainer.innerHTML = "<p>Error loading timeline data</p>";
        return;
      }
      // Filter out placeholder entries
      dfData = dfData.filter(entry => entry.TIME !== '00:00-00:00');
      if (dfData.length === 0) {
        timelineContainer.innerHTML = "<p>No active schedule entries found</p>";
        return;
      }
      const items = [];
      const groups = [];
      const groupMap = {};
      dfData.forEach((entry) => {
        const groupId = entry.PPL;
        const startTimeParts = entry.start_time.split(':');
        const startDateTime = new Date();
        startDateTime.setHours(parseInt(startTimeParts[0], 10), parseInt(startTimeParts[1], 10), 0);
        if (!groupMap[groupId]) {
          groupMap[groupId] = { id: groupId, order: startDateTime };
          groups.push(groupMap[groupId]);
        } else {
          if (startDateTime < groupMap[groupId].order) {
            groupMap[groupId].order = startDateTime;
          }
        }
      });
      groups.sort((a, b) => a.order - b.order);
      const finalGroups = groups.map(group => ({ id: group.id, content: group.id }));
      dfData.forEach((entry, index) => {
        const startTimeParts = entry.start_time.split(':');
        const endTimeParts = entry.end_time.split(':');
        const startDateTime = new Date();
        startDateTime.setHours(parseInt(startTimeParts[0], 10), parseInt(startTimeParts[1], 10), 0);
        const endDateTime = new Date();
        endDateTime.setHours(parseInt(endTimeParts[0], 10), parseInt(endTimeParts[1], 10), 0);
        const activeSkills = [];
        skillColumns.forEach(skillName => {
          if (entry[skillName] > 0) {
            const slug = skillSlugMap[skillName] || skillName.toLowerCase();
            activeSkills.push(slug);
          }
        });
        const customClass = `timeline-item-${index}`;
        const customStyle = document.createElement('style');
        customStyle.textContent = `.${customClass} { ${buildGradient(activeSkills)} }`;
        document.head.appendChild(customStyle);
        items.push({
          id: index,
          group: entry.PPL,
          start: startDateTime,
          end: endDateTime,
          content: '',
          title: `${entry.PPL}<br>Zeit: ${entry.TIME}<br>Skills: ${activeSkills.join(', ')}`,
          className: customClass
        });
      });
      const today = new Date();
      const options = {
        zoomable: false,
        moveable: true,
        stack: false,
        min: new Date(today.setHours(7, 0, 0)),
        max: new Date(today.setHours(20, 0, 0)),
        showCurrentTime: true,
        format: {
          minorLabels: {
            hour: 'HH:mm',
            minute: 'HH:mm'
          }
        },
        orientation: {
          axis: 'top',
          item: 'top'
        },
        margin: { item: { vertical: 10 } },
        verticalScroll: true,
        //maxHeight: '800px'
      };
      const timeline = new vis.Timeline(timelineContainer, items, finalGroups, options);
      setInterval(() => {
        timeline.setCurrentTime(new Date());
      }, 60000);
      timeline.setWindow(
        new Date(today.setHours(Math.max(7, new Date().getHours() - 1), 0, 0)),
        new Date(today.setHours(Math.min(20, new Date().getHours() + 2), 0, 0))
      );
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      buildTimeline();
    });
  </script>
</body>
</html>
