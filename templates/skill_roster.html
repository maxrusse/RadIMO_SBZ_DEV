{% extends 'base.html' %}

{% block title %}RadIMO Cortex | Skill Matrix{% endblock %}

{% block styles %}
    :root {
      --app-header-bg: #004892;
      --app-header-text: #fff;
      --app-header-link-color: #fff;
      --app-header-link-bg: rgba(255, 255, 255, 0.2);
      --app-header-link-hover-bg: rgba(255, 255, 255, 0.3);
      --app-header-link-active-bg: rgba(255, 255, 255, 0.4);
      --app-header-link-active-color: #fff;
      --app-subheader-bg: rgba(255, 255, 255, 0.2);
      --app-subheader-text: #fff;
      --header-context-color: #e6eef8;
      --header-context-global-color: #fff;
      --pill-bg: rgba(255, 255, 255, 0.2);
      --pill-hover-bg: rgba(255, 255, 255, 0.3);
      --pill-active-bg: rgba(255, 255, 255, 0.4);
      --pill-color: #fff;
      --pill-active-color: #fff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f0f0;
      padding: 1rem;
      max-width: 1800px;
      margin: 0 auto;
    }

    .toolbar {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #004892;
      color: white;
    }

    .btn-primary:hover {
      background: #003670;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 1rem;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .worker-list {
      max-height: 70vh;
      overflow-y: auto;
    }

    .worker-list h3 {
      margin-bottom: 0.75rem;
      font-size: 1rem;
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }

    .worker-item {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .worker-item:hover {
      background: #f0f0f0;
    }

    .worker-item.active {
      background: #004892;
      color: white;
    }

    .worker-detail h3 {
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .matrix-table th,
    .matrix-table td {
      padding: 0.5rem;
      text-align: center;
      border: 1px solid #e0e0e0;
    }

    .matrix-table th {
      background: #f8f9fa;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .matrix-table th.skill-col {
      text-align: left;
      min-width: 100px;
    }

    .matrix-table td.skill-name {
      text-align: left;
      font-weight: 500;
      background: #fafafa;
    }

    .matrix-table td.invalid {
      background: #f5f5f5;
      color: #bbb;
    }

    .skill-input {
      width: 50px;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .skill-input:focus {
      outline: 2px solid #004892;
      border-color: transparent;
    }

    .skill-input.value-1 {
      background: #d4edda;
      border-color: #28a745;
    }

    .skill-input.value-0 {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .skill-input.value--1 {
      background: #f8d7da;
      border-color: #dc3545;
    }

    .skill-input.value-w {
      background: #cce5ff;
      border-color: #007bff;
    }

    .skill-select {
      width: 60px;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .skill-select:focus {
      outline: 2px solid #004892;
      border-color: transparent;
    }

    .modifier-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }

    .modifier-row label {
      font-weight: 500;
      color: #333;
    }

    .modifier-input {
      width: 80px;
      padding: 0.4rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .modifier-help {
      font-size: 0.8rem;
      color: #666;
    }

    .add-worker {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #ddd;
    }

    .add-worker input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .add-worker button {
      width: 100%;
    }

    .status-message {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
      z-index: 1000;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .worker-list {
        max-height: 200px;
      }
    }
{% endblock %}

{% block content %}
  {% set header_title = 'RadIMO Cortex | Skill Matrix' %}
  {% set header_subtitle = 'Worker skill × modality configuration' %}
  {% set header_mode = 'global' %}
  {% set header_links = [
    {'href': url_for('routes.worker_load_monitor'), 'label': 'Worker Load'},
    {'href': url_for('routes.skill_roster_page'), 'label': 'Skill Matrix', 'active': True},
    {'href': url_for('routes.prep_today'), 'label': 'Change Today'},
    {'href': url_for('routes.prep_tomorrow'), 'label': 'Prep Tomorrow'},
    {'href': url_for('routes.upload_file'), 'label': 'Upload'},
    {'href': url_for('routes.logout'), 'label': 'Logout', 'accent': True},
    {'href': url_for('routes.timetable', modality='all'), 'label': 'Timetable'},
    {'href': url_for('routes.index'), 'label': 'Dashboard'}
  ] %}
  {% include 'partials/header.html' %}

  <div class="toolbar">
    <div>
      <strong>Values:</strong>
      <span style="color: #28a745;">1 = assigned</span> ·
      <span style="color: #007bff;">w = weighted (training)</span> ·
      <span style="color: #856404;">0 = helper</span> ·
      <span style="color: #dc3545;">-1 = excluded</span>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button class="btn btn-primary" onclick="importNewWorkers()">Import new workers</button>
      <button class="btn btn-secondary" onclick="loadRoster()">Reload</button>
      <button class="btn btn-success" onclick="saveRoster()">Save</button>
    </div>
  </div>

  <div class="main-layout">
    <!-- Worker List -->
    <div class="card worker-list">
      <h3>Workers</h3>
      <div id="workerListContainer"></div>
      <div class="add-worker">
        <input type="text" id="newWorkerId" placeholder="ID or Name (ID)">
        <button class="btn btn-primary" onclick="addWorker()">Add Worker</button>
      </div>
    </div>

    <!-- Worker Detail -->
    <div class="card worker-detail">
      <div id="noWorkerSelected" class="empty-state">
        <p>Select a worker to edit skills</p>
      </div>
      <div id="workerDetailContent" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 id="selectedWorkerTitle">Worker: -</h3>
          <button class="btn btn-secondary" style="background: #dc3545;" onclick="deleteWorker()">Delete</button>
        </div>
        <div class="modifier-row">
          <label for="workerModifier">Global Modifier:</label>
          <input type="number" id="workerModifier" class="modifier-input" step="0.1" min="0.1" max="2.0" value="{{ default_w_modifier }}" onchange="updateModifier(this.value)">
          <span class="modifier-help">(Used for 'w' assignments. Default {{ default_w_modifier }} = training/50% load)</span>
        </div>
        <div style="overflow-x: auto;">
          <table class="matrix-table">
            <thead>
              <tr id="matrixHeader"></tr>
            </thead>
            <tbody id="matrixBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="statusMessage" class="status-message"></div>

  <script>
    let rosterData = {};
    let workerNames = {};  // Mapping from worker ID to display name
    let skills = [];
    let modalities = [];
    let selectedWorker = null;
    let isDirty = false;  // Track unsaved changes
    const validSkillsMap = JSON.parse('{{ valid_skills_map|tojson|safe }}');
    const defaultWModifier = {{ default_w_modifier|tojson|safe }};

    function isValidCombination(modality, skill) {
      if (!validSkillsMap[modality]) return true;
      return validSkillsMap[modality].includes(skill);
    }

    // Mark data as dirty (unsaved changes)
    function markDirty() {
      if (!isDirty) {
        isDirty = true;
        updateSaveButtonState();
      }
    }

    // Mark data as clean (saved)
    function markClean() {
      isDirty = false;
      updateSaveButtonState();
    }

    // Update save button to show unsaved state
    function updateSaveButtonState() {
      const saveBtn = document.querySelector('.btn-success');
      if (saveBtn) {
        saveBtn.textContent = isDirty ? 'Save *' : 'Save';
        saveBtn.style.boxShadow = isDirty ? '0 0 0 2px #ffc107' : '';
      }
    }

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function (e) {
      if (isDirty) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });

    document.addEventListener('DOMContentLoaded', loadRoster);

    async function loadRoster() {
      try {
        const response = await fetch('/api/admin/skill_roster');
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        const data = await response.json();
        if (data.success) {
          rosterData = data.roster;
          workerNames = data.worker_names || {};
          skills = data.skills;
          modalities = data.modalities;
          renderWorkerList();
          if (selectedWorker && rosterData[selectedWorker]) {
            renderWorkerMatrix();
          }
          markClean();
        } else {
          showStatus('Load failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    function getWorkerDisplayName(workerId) {
      // Returns display name with ID if available, otherwise just the ID
      const fullName = workerNames[workerId];
      if (fullName && fullName !== workerId) {
        // If full name already contains the ID in parentheses, use it as-is
        if (fullName.includes('(' + workerId + ')')) {
          return fullName;
        }
        // Otherwise, append ID in parentheses
        return fullName + ' (' + workerId + ')';
      }
      return workerId;
    }

    function renderWorkerList() {
      const container = document.getElementById('workerListContainer');
      container.innerHTML = '';
      Object.keys(rosterData).sort().forEach(workerId => {
        const div = document.createElement('div');
        div.className = 'worker-item' + (selectedWorker === workerId ? ' active' : '');
        div.textContent = getWorkerDisplayName(workerId);
        div.title = workerId;  // Tooltip shows the ID
        div.onclick = () => selectWorker(workerId);
        container.appendChild(div);
      });
    }

    function selectWorker(workerId) {
      selectedWorker = workerId;
      renderWorkerList();
      renderWorkerMatrix();
      document.getElementById('noWorkerSelected').style.display = 'none';
      document.getElementById('workerDetailContent').style.display = 'block';
      document.getElementById('selectedWorkerTitle').textContent = 'Worker: ' + getWorkerDisplayName(workerId);
    }

    function renderWorkerMatrix() {
      if (!selectedWorker || !rosterData[selectedWorker]) return;
      const workerData = rosterData[selectedWorker];

      // Header: Skill | CT | MR | X-ray | Mammo
      const header = document.getElementById('matrixHeader');
      header.innerHTML = '<th class="skill-col">Skill</th>';
      modalities.forEach(mod => {
        const th = document.createElement('th');
        th.textContent = mod.toUpperCase();
        header.appendChild(th);
      });

      // Body: each skill row
      const tbody = document.getElementById('matrixBody');
      tbody.innerHTML = '';

      skills.forEach(skill => {
        const row = document.createElement('tr');

        // Skill name
        const skillCell = document.createElement('td');
        skillCell.className = 'skill-name';
        skillCell.textContent = skill;
        row.appendChild(skillCell);

        // Value for each modality
        modalities.forEach(mod => {
          const cell = document.createElement('td');

          if (!isValidCombination(mod, skill)) {
            cell.className = 'invalid';
            cell.textContent = '—';
            row.appendChild(cell);
            return;
          }

          // Get value from flat structure: "skill_modality" format
          const key = `${skill}_${mod}`;
          let value = workerData[key];
          if (value === undefined) value = 0;

          // Use select dropdown to support 'w' value
          const select = document.createElement('select');
          select.className = 'skill-select skill-input';

          const options = [
            { value: '1', label: '1' },
            { value: '0', label: '0' },
            { value: 'w', label: 'w' },
            { value: '-1', label: '-1' }
          ];

          options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });

          // Set current value (normalize to string for comparison)
          const strValue = String(value).toLowerCase();
          select.value = strValue === 'w' ? 'w' : String(parseInt(value) || 0);
          applyValueColor(select, select.value);

          select.addEventListener('change', function () {
            const val = this.value;
            updateSkill(mod, skill, val === 'w' ? 'w' : parseInt(val));
            applyValueColor(this, val);
            markDirty();
          });

          cell.appendChild(select);
          row.appendChild(cell);
        });

        tbody.appendChild(row);
      });

      // Update modifier input
      const modifierInput = document.getElementById('workerModifier');
      const modifier = workerData.modifier !== undefined ? workerData.modifier : defaultWModifier;
      modifierInput.value = modifier;
    }

    function applyValueColor(element, val) {
      element.classList.remove('value--1', 'value-0', 'value-1', 'value-w');
      const strVal = String(val).toLowerCase();
      if (strVal === '1') element.classList.add('value-1');
      else if (strVal === 'w') element.classList.add('value-w');
      else if (strVal === '0') element.classList.add('value-0');
      else if (strVal === '-1') element.classList.add('value--1');
    }

    function updateModifier(value) {
      if (!rosterData[selectedWorker]) return;
      let val = parseFloat(value);
      if (isNaN(val) || val < 0.1) val = 0.1;
      if (val > 2.0) val = 2.0;
      rosterData[selectedWorker].modifier = val;
      document.getElementById('workerModifier').value = val;
      markDirty();
    }

    function updateSkill(modality, skill, value) {
      if (!rosterData[selectedWorker]) return;
      // Write to flat structure: "skill_modality" format
      const key = `${skill}_${modality}`;
      rosterData[selectedWorker][key] = value;
    }

    function parseWorkerInput(inputValue) {
      // Parse input like "Dr. Name (ID)" or just "ID"
      // Returns { id, fullName }
      const match = inputValue.match(/^(.+?)\s*\(([^)]+)\)$/);
      if (match) {
        return { id: match[2].trim(), fullName: inputValue };
      }
      return { id: inputValue, fullName: null };
    }

    function addWorker() {
      const input = document.getElementById('newWorkerId');
      const inputValue = input.value.trim();
      if (!inputValue) {
        showStatus('Please enter a worker ID or "Name (ID)"', 'error');
        return;
      }

      const { id: workerId, fullName } = parseWorkerInput(inputValue);
      if (rosterData[workerId]) {
        showStatus('Worker already exists', 'error');
        return;
      }

      // Create new worker with flat Skill×Modality combinations (all set to 0)
      rosterData[workerId] = { modifier: defaultWModifier };
      if (fullName) {
        rosterData[workerId].full_name = fullName;
        workerNames[workerId] = fullName;  // Update display cache
      }
      skills.forEach(skill => {
        modalities.forEach(mod => {
          if (isValidCombination(mod, skill)) {
            const key = `${skill}_${mod}`;
            rosterData[workerId][key] = 0;
          }
        });
      });

      input.value = '';
      renderWorkerList();
      selectWorker(workerId);
      markDirty();
      showStatus('Worker added (save to keep)', 'success');
    }

    function deleteWorker() {
      if (!selectedWorker) return;
      if (!confirm('Delete worker ' + getWorkerDisplayName(selectedWorker) + '?')) return;

      delete rosterData[selectedWorker];
      selectedWorker = null;
      renderWorkerList();
      document.getElementById('noWorkerSelected').style.display = 'block';
      document.getElementById('workerDetailContent').style.display = 'none';
      markDirty();
      showStatus('Worker deleted (save to keep)', 'success');
    }

    async function importNewWorkers() {
      try {
        const response = await fetch('/api/admin/skill_roster/import_new', { method: 'POST' });
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        if (result.success) {
          await loadRoster();
          const count = result.added_count || 0;
          const list = (result.added_workers || []).join(', ');
          const suffix = list ? `: ${list}` : '';
          showStatus(`Imported ${count} new worker(s)` + suffix, 'success');
        } else {
          showStatus('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    async function saveRoster() {
      try {
        const response = await fetch('/api/admin/skill_roster', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roster: rosterData })
        });
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        const result = await response.json();
        if (result.success) {
          markClean();
          showStatus('Saved!', 'success');
        } else {
          showStatus('Save failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    function showStatus(message, type) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status-message ' + type;
      setTimeout(() => { el.className = 'status-message'; }, 4000);
    }
  </script>
{% endblock %}
