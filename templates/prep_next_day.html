<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Cortex | Master Schedule</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f0f0; padding: 1rem; max-width: 1600px; margin: 0 auto; }
    .header { background: #004892; color: white; padding: 1rem 2rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .header-actions a, .header-actions button { color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .header-actions a:hover, .header-actions button:hover { background: rgba(255,255,255,0.3); }
    .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .info-box { background: #e7f3ff; border-left: 4px solid #004892; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.9rem; }
    .staging-banner { background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    .staging-banner h2 { color: #856404; margin-bottom: 0.5rem; font-size: 1.2rem; }
    .staging-banner p { color: #856404; margin: 0.25rem 0; font-size: 0.9rem; }
    .activate-section { background: #d1ecf1; border: 2px solid #0c5460; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    .activate-section h3 { color: #0c5460; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .btn-activate { background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
    .btn-activate:hover { background: #218838; }
    .mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .mode-toggle button { padding: 0.5rem 1rem; border: 2px solid #004892; background: white; color: #004892; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .mode-toggle button.active { background: #004892; color: white; }
    .table-container { max-height: 500px; overflow: auto; }
    .edit-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .edit-table th, .edit-table td { padding: 0.4rem; text-align: left; border: 1px solid #ddd; }
    .edit-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
    .edit-table td[contenteditable="true"] { background: #fffbf0; cursor: text; }
    .edit-table td[contenteditable="true"]:hover { background: #fff4cc; }
    .edit-table td[contenteditable="true"]:focus { outline: 2px solid #004892; background: white; }
    .edit-table tr:hover { background: #f8f9fa; }
    .skill-cell { text-align: center; font-weight: 600; }
    .skill-1 { background: #d4edda; color: #155724; }
    .skill-0 { background: #fff3cd; color: #856404; }
    .skill--1 { background: #f8d7da; color: #721c24; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .btn-primary { background: #004892; color: white; }
    .btn-primary:hover { background: #003670; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-small { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
    .message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
    .advanced-tools { display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; }
    .advanced-tools.visible { display: block; }
    .bulk-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .filter-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; gap: 0.25rem; align-items: center; }
    .filter-group label { font-weight: 600; color: #666; font-size: 0.85rem; margin-right: 0.5rem; }
    .filter-btn { padding: 0.3rem 0.6rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .filter-btn:hover { border-color: #004892; }
    .filter-btn.active { background: #004892; color: white; border-color: #004892; }
    .add-worker-panel { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #28a745; }
    .add-worker-panel h4 { margin: 0 0 1rem 0; color: #28a745; }
    .add-worker-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: flex-end; }
    .add-worker-row .form-group { display: flex; flex-direction: column; }
    .add-worker-row .form-group label { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; }
    .add-worker-row select, .add-worker-row input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
    .task-dropdown { position: relative; display: inline-block; }
    .task-dropdown-content { display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 100; border-radius: 4px; padding: 0.5rem; max-height: 200px; overflow-y: auto; }
    .task-dropdown-content.show { display: block; }
    .task-dropdown-content label { display: block; padding: 0.3rem 0.5rem; cursor: pointer; font-size: 0.85rem; }
    .task-dropdown-content label:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>RadIMO Cortex | Master Schedule</h1>
      <p style="font-size: 0.85rem; opacity: 0.9;">Unified schedule view - Load from CSV, edit, then Activate</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('skill_roster_page') }}">Skill Matrix</a>
      <a href="{{ url_for('upload_file') }}">Upload</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div id="message-container"></div>

  <div class="card" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
    <strong>Load from CSV:</strong>
    <button class="btn btn-primary" onclick="loadFromCSV('today')">Load Today</button>
    <button class="btn btn-primary" onclick="loadFromCSV('next')">Load Next Day</button>
    <span id="load-status" style="color: #666;"></span>
  </div>

  <div class="staging-banner">
    <h2>STAGING MODE - No Live Effect</h2>
    <p>Changes are saved to STAGED area. Use "Activate" to apply to live schedule.</p>
  </div>

  <div class="activate-section">
    <h3>Activate Staged Schedule</h3>
    <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">This copies Staged → Live and resets all counters!</p>
    <button class="btn-activate" onclick="activateStagedSchedule()">
      ACTIVATE (Staged → Live)
    </button>
  </div>

  <div class="card">
    <div class="info-box">
      <strong>Master Schedule</strong> - Edit workers, times, and skills. Changes saved to STAGED area until Activated.
    </div>

    <div class="mode-toggle">
      <button id="mode-simple" class="active" onclick="setMode('simple')">Simple (Edit Cells)</button>
      <button id="mode-advanced" onclick="setMode('advanced')">Advanced (Add/Delete)</button>
    </div>

    <div class="filter-row">
      <div class="filter-group">
        <label>Modality:</label>
        <button class="filter-btn active" onclick="setModalityFilter('all')">ALL</button>
        {% for mod in modalities %}
        <button class="filter-btn" onclick="setModalityFilter('{{ mod }}')">{{ mod|upper }}</button>
        {% endfor %}
      </div>
      <div class="filter-group">
        <label>Skill:</label>
        <button class="filter-btn active" onclick="setSkillFilter('all')">ALL</button>
        {% for skill in skills %}
        <button class="filter-btn" onclick="setSkillFilter('{{ skill }}')">{{ skill }}</button>
        {% endfor %}
      </div>
    </div>

    <div class="table-container">
      <table class="edit-table" id="edit-table">
        <thead>
          <tr>
            <th>Worker</th>
            <th>Modality</th>
            <th>Von</th>
            <th>Bis</th>
            {% for skill in skills %}
            <th>{{ skill }}</th>
            {% endfor %}
            <th>Mod</th>
            <th id="actions-header" style="display:none;">Actions</th>
          </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
      </table>
    </div>

    <div id="advanced-tools" class="advanced-tools">
      <!-- Add Worker Panel -->
      <div class="add-worker-panel">
        <h4>+ Add Worker</h4>
        <div class="add-worker-row">
          <div class="form-group">
            <label>Worker (from Skill Matrix)</label>
            <select id="add-worker-select">
              <option value="">-- Select Worker --</option>
            </select>
          </div>
          <div class="form-group">
            <label>Activity/Role</label>
            <select id="add-activity-select" onchange="onActivityChange()">
              <option value="">-- Select Activity --</option>
              {% for rule in medweb_mapping.get('rules', []) %}
              {% if not rule.get('exclusion') %}
              <option value="{{ rule.match }}"
                      data-modality="{{ rule.get('modality', '') }}"
                      data-modalities="{{ rule.get('modalities', [])|tojson }}"
                      data-shift="{{ rule.get('shift', 'Fruehdienst') }}"
                      data-skills="{{ rule.get('base_skills', {})|tojson }}">
                {{ rule.match }}
              </option>
              {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Shift</label>
            <select id="add-shift-select" onchange="onShiftChange()">
              {% for shift_name, shift_data in shift_times.items() %}
              <option value="{{ shift_name }}" data-times="{{ shift_data|tojson }}">
                {{ shift_name }} ({{ shift_data.get('default', '') }})
              </option>
              {% endfor %}
              <option value="custom">Custom...</option>
            </select>
          </div>
          <div class="form-group" id="custom-time-group" style="display: none;">
            <label>Von - Bis</label>
            <div style="display: flex; gap: 0.25rem;">
              <input type="time" id="add-start-time" value="07:00" style="width: 100px;">
              <input type="time" id="add-end-time" value="15:00" style="width: 100px;">
            </div>
          </div>
          <div class="form-group">
            <label>Tasks</label>
            <div class="task-dropdown">
              <button type="button" class="btn btn-secondary" onclick="toggleTaskDropdown()">Select Tasks ▼</button>
              <div id="task-dropdown-content" class="task-dropdown-content">
                {% for rule in medweb_mapping.get('rules', []) %}
                {% if rule.get('exclusion') %}
                <label><input type="checkbox" value="{{ rule.match }}"> {{ rule.match }}</label>
                {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          <button class="btn btn-success" onclick="addWorkerFromPanel()">Add</button>
        </div>
        <div id="activity-info" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;"></div>
      </div>

      <h4 style="margin-bottom: 0.5rem;">Bulk Actions</h4>
      <div class="bulk-actions">
        <button class="btn btn-primary" onclick="bulkSetSkill()">Bulk Set Skill</button>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <button class="btn btn-success" onclick="saveAllChanges()" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
        Save All Changes
      </button>
      <span id="save-status" style="margin-left: 1rem; color: #666;"></span>
    </div>
  </div>

  <script>
    // Dynamic configuration from backend
    const SKILLS = {{ skills|tojson }};
    const MODALITIES = {{ modalities|tojson }};
    const SHIFT_TIMES = {{ shift_times|tojson }};

    let currentModalityFilter = 'all';  // Filter: 'all' or specific modality
    let currentSkillFilter = 'all';     // Filter: 'all' or specific skill (shows where skill=1)
    let currentMode = 'simple';
    let tableData = {};  // {modality: [rows]}
    let allData = [];    // Combined data from all modalities
    let pendingChanges = {};
    let skillRosterWorkers = [];  // Workers from skill roster for dropdown
    let selectedActivityData = null;  // Current selected activity's data

    async function loadData() {
      try {
        const response = await fetch('/api/prep-next-day/data');
        const data = await response.json();
        tableData = data;

        // Combine all modalities into unified list
        allData = [];
        MODALITIES.forEach(mod => {
          const modData = tableData[mod] || [];
          modData.forEach(row => {
            allData.push({ ...row, _modality: mod });
          });
        });

        renderTable();
      } catch (error) {
        showMessage('error', `Error loading: ${error.message}`);
      }
    }

    async function loadSkillRosterWorkers() {
      try {
        const response = await fetch('/api/admin/skill_roster');
        const data = await response.json();
        skillRosterWorkers = Object.keys(data);
        populateWorkerDropdown();
      } catch (error) {
        console.log('Could not load skill roster:', error.message);
      }
    }

    function populateWorkerDropdown() {
      const select = document.getElementById('add-worker-select');
      select.innerHTML = '<option value="">-- Select Worker --</option>';
      skillRosterWorkers.forEach(worker => {
        const opt = document.createElement('option');
        opt.value = worker;
        opt.textContent = worker;
        select.appendChild(opt);
      });
    }

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('mode-simple').classList.toggle('active', mode === 'simple');
      document.getElementById('mode-advanced').classList.toggle('active', mode === 'advanced');
      document.getElementById('advanced-tools').classList.toggle('visible', mode === 'advanced');
      document.getElementById('actions-header').style.display = mode === 'advanced' ? '' : 'none';
      renderTable();
    }

    function setModalityFilter(filter) {
      currentModalityFilter = filter;
      // Update button states in modality filter group
      document.querySelectorAll('.filter-row .filter-group:first-child .filter-btn').forEach(btn => {
        const btnFilter = btn.textContent.toLowerCase() === 'all' ? 'all' : btn.textContent.toLowerCase();
        btn.classList.toggle('active', btnFilter === filter);
      });
      renderTable();
    }

    function setSkillFilter(skill) {
      currentSkillFilter = skill;
      // Update button states in skill filter group
      document.querySelectorAll('.filter-row .filter-group:last-child .filter-btn').forEach(btn => {
        const btnSkill = btn.textContent === 'ALL' ? 'all' : btn.textContent;
        btn.classList.toggle('active', btnSkill === skill);
      });
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      // Filter data based on modality filter
      let data = allData;
      if (currentModalityFilter !== 'all') {
        data = data.filter(row => row._modality === currentModalityFilter);
      }

      // Filter by skill (show workers where skill=1)
      if (currentSkillFilter !== 'all') {
        data = data.filter(row => row[currentSkillFilter] === 1 || row[currentSkillFilter] === '1');
      }

      if (data.length === 0) {
        const colSpan = 5 + SKILLS.length + (currentMode === 'advanced' ? 1 : 0);
        let emptyMsg = 'No data. Upload CSV first.';
        if (allData.length > 0) {
          emptyMsg = `No workers match current filters (Modality: ${currentModalityFilter}, Skill: ${currentSkillFilter})`;
        }
        tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align: center; padding: 2rem; color: #666;">${emptyMsg}</td></tr>`;
        return;
      }

      data.forEach((row) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = row.row_index;
        tr.dataset.modality = row._modality;

        // Worker name
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="PPL">${row.PPL}</td>`;
        // Modality (always visible, editable via dropdown in advanced mode later)
        tr.innerHTML += `<td style="font-weight: bold; text-transform: uppercase;">${row._modality}</td>`;
        // Times
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="start_time">${row.start_time}</td>`;
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="end_time">${row.end_time}</td>`;

        // Skills
        SKILLS.forEach(skill => {
          const value = row[skill] !== undefined ? row[skill] : 0;
          const className = `skill-cell skill-${value}`;
          tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="${skill}" class="${className}">${value}</td>`;
        });

        // Modifier
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="Modifier">${row.Modifier || 1.0}</td>`;

        // Actions (advanced mode)
        if (currentMode === 'advanced') {
          tr.innerHTML += `<td><button class="btn btn-danger btn-small" onclick="deleteWorkerRow('${row._modality}', ${row.row_index})">Del</button></td>`;
        }

        tbody.appendChild(tr);
      });

      // Add event listeners
      document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('blur', handleCellEdit);
      });
    }

    function handleCellEdit(event) {
      const cell = event.target;
      const row = cell.parentElement;
      const rowIndex = parseInt(row.dataset.rowIndex);
      const rowModality = row.dataset.modality;  // Always use row's modality
      const col = cell.dataset.col;
      const newValue = cell.textContent.trim();

      if (!pendingChanges[rowModality]) pendingChanges[rowModality] = {};
      if (!pendingChanges[rowModality][rowIndex]) pendingChanges[rowModality][rowIndex] = {};
      pendingChanges[rowModality][rowIndex][col] = newValue;

      const dataRow = tableData[rowModality]?.find(r => r.row_index === rowIndex);
      if (dataRow) dataRow[col] = newValue;

      cell.style.background = '#d4edda';
      setTimeout(() => { cell.style.background = ''; }, 500);
    }

    async function saveAllChanges() {
      const saveStatus = document.getElementById('save-status');
      saveStatus.textContent = 'Saving...';
      let successCount = 0, errorCount = 0;

      for (const modality in pendingChanges) {
        for (const rowIndex in pendingChanges[modality]) {
          try {
            const response = await fetch('/api/prep-next-day/update-row', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ modality, row_index: parseInt(rowIndex), updates: pendingChanges[modality][rowIndex] })
            });
            response.ok ? successCount++ : errorCount++;
          } catch { errorCount++; }
        }
      }

      pendingChanges = {};
      saveStatus.textContent = errorCount === 0 ? `${successCount} saved` : `${successCount} saved, ${errorCount} errors`;
      saveStatus.style.color = errorCount === 0 ? '#28a745' : '#dc3545';
      showMessage(errorCount === 0 ? 'success' : 'error', saveStatus.textContent);
      setTimeout(() => { saveStatus.textContent = ''; }, 3000);
    }

    async function deleteWorkerRow(modality, rowIndex) {
      if (!confirm('Delete this worker?')) return;
      try {
        const response = await fetch('/api/prep-next-day/delete-worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modality: modality, row_index: rowIndex })
        });
        if (response.ok) { showMessage('success', 'Deleted'); await loadData(); }
        else showMessage('error', 'Failed');
      } catch (error) { showMessage('error', error.message); }
    }

    function bulkSetSkill() {
      const skillList = SKILLS.join(', ');
      const skill = prompt(`Skill Name (${skillList}):`, SKILLS[0]);
      if (!skill || !SKILLS.includes(skill)) { alert('Invalid skill'); return; }

      const value = prompt(`Value for ${skill} (-1=excluded, 0=passive, 1=active):`, '1');
      if (value === null) return;
      const parsedValue = parseInt(value);
      if (![-1, 0, 1].includes(parsedValue)) { alert('Invalid value! Use -1, 0, or 1'); return; }

      // Apply to all visible (filtered) workers
      let targetData = allData;
      if (currentModalityFilter !== 'all') {
        targetData = targetData.filter(r => r._modality === currentModalityFilter);
      }
      if (currentSkillFilter !== 'all') {
        targetData = targetData.filter(r => r[currentSkillFilter] === 1 || r[currentSkillFilter] === '1');
      }
      targetData.forEach(row => {
        row[skill] = parsedValue;
        if (!pendingChanges[row._modality]) pendingChanges[row._modality] = {};
        if (!pendingChanges[row._modality][row.row_index]) pendingChanges[row._modality][row.row_index] = {};
        pendingChanges[row._modality][row.row_index][skill] = parsedValue;
      });

      renderTable();
      showMessage('success', `Set ${skill}=${parsedValue} for ${targetData.length} workers`);
    }

    async function loadFromCSV(mode) {
      const loadStatus = document.getElementById('load-status');
      loadStatus.textContent = 'Loading...';

      const endpoint = mode === 'today' ? '/load-today-from-master' : '/preload-from-master';
      try {
        const response = await fetch(endpoint, { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
          loadStatus.textContent = result.message || 'Loaded!';
          loadStatus.style.color = '#28a745';
          await loadData();  // Refresh table
        } else {
          loadStatus.textContent = result.error || 'Error';
          loadStatus.style.color = '#dc3545';
          if (result.debug) {
            console.log('Debug:', result.debug);
          }
        }
      } catch (error) {
        loadStatus.textContent = 'Error: ' + error.message;
        loadStatus.style.color = '#dc3545';
      }

      setTimeout(() => { loadStatus.textContent = ''; }, 5000);
    }

    function showMessage(type, message) {
      const container = document.getElementById('message-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    async function activateStagedSchedule() {
      if (!confirm('WARNING!\n\nThis copies STAGED → LIVE and resets all counters!\n\nContinue?')) return;
      if (!confirm('Final confirmation: All assignment counters will be reset. Activate?')) return;

      try {
        const response = await fetch('/api/prep-next-day/activate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modalities: MODALITIES })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('success', `Activated! Modalities: ${result.activated_modalities.join(', ')}, Workers: ${result.total_workers}`);
        } else {
          showMessage('error', result.error || 'Unknown error');
        }
      } catch (error) { showMessage('error', error.message); }
    }

    // Toggle task dropdown visibility
    function toggleTaskDropdown() {
      const dropdown = document.getElementById('task-dropdown-content');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.task-dropdown')) {
        document.getElementById('task-dropdown-content')?.classList.remove('show');
      }
    });

    // Handle activity selection - auto-set shift and show info
    function onActivityChange() {
      const activitySelect = document.getElementById('add-activity-select');
      const shiftSelect = document.getElementById('add-shift-select');
      const infoDiv = document.getElementById('activity-info');
      const selectedOption = activitySelect.options[activitySelect.selectedIndex];

      if (!selectedOption || !selectedOption.value) {
        selectedActivityData = null;
        infoDiv.textContent = '';
        return;
      }

      // Parse data attributes
      const modality = selectedOption.dataset.modality;
      let modalities = [];
      try {
        modalities = JSON.parse(selectedOption.dataset.modalities || '[]');
      } catch (e) {}
      const shift = selectedOption.dataset.shift || 'Fruehdienst';
      let skills = {};
      try {
        skills = JSON.parse(selectedOption.dataset.skills || '{}');
      } catch (e) {}

      // Store for use in addWorkerFromPanel
      selectedActivityData = {
        modality: modality,
        modalities: modalities,
        shift: shift,
        skills: skills
      };

      // Auto-select the shift
      if (shift && shiftSelect) {
        for (let i = 0; i < shiftSelect.options.length; i++) {
          if (shiftSelect.options[i].value === shift) {
            shiftSelect.selectedIndex = i;
            onShiftChange();  // Update times
            break;
          }
        }
      }

      // Show info about selected activity
      const modalityInfo = modality ? modality.toUpperCase() : (modalities.length ? modalities.map(m => m.toUpperCase()).join(', ') : '');
      const skillInfo = Object.entries(skills).filter(([k, v]) => v === 1).map(([k]) => k).join(', ');
      infoDiv.innerHTML = `<strong>Modality:</strong> ${modalityInfo || 'Multi'} | <strong>Skills:</strong> ${skillInfo || 'None'}`;
    }

    // Handle shift dropdown change for custom time
    function onShiftChange() {
      const shiftSelect = document.getElementById('add-shift-select');
      const customGroup = document.getElementById('custom-time-group');
      const startInput = document.getElementById('add-start-time');
      const endInput = document.getElementById('add-end-time');

      if (shiftSelect.value === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
        // Get times from shift config
        const shiftConfig = SHIFT_TIMES[shiftSelect.value];
        if (shiftConfig) {
          const defaultTime = shiftConfig.default || '';
          const [start, end] = defaultTime.split('-');
          if (start) startInput.value = start;
          if (end) endInput.value = end;
        }
      }
    }

    // Add worker from panel (activity-based)
    async function addWorkerFromPanel() {
      const workerSelect = document.getElementById('add-worker-select');
      const activitySelect = document.getElementById('add-activity-select');
      const shiftSelect = document.getElementById('add-shift-select');
      const startInput = document.getElementById('add-start-time');
      const endInput = document.getElementById('add-end-time');

      const workerName = workerSelect.value;

      if (!workerName) {
        showMessage('error', 'Please select a worker');
        return;
      }

      if (!selectedActivityData && !activitySelect.value) {
        showMessage('error', 'Please select an activity/role');
        return;
      }

      // Get times based on shift or custom
      let startTime = startInput.value || '07:00';
      let endTime = endInput.value || '15:00';

      if (shiftSelect.value !== 'custom') {
        const shiftConfig = SHIFT_TIMES[shiftSelect.value];
        if (shiftConfig) {
          const defaultTime = shiftConfig.default || '';
          const [start, end] = defaultTime.split('-');
          if (start) startTime = start;
          if (end) endTime = end;
        }
      }

      // Get selected tasks
      const taskCheckboxes = document.querySelectorAll('#task-dropdown-content input[type="checkbox"]:checked');
      const selectedTasks = Array.from(taskCheckboxes).map(cb => cb.value);

      // Use activity skills as base, or default all to 0
      let workerSkills = {};
      SKILLS.forEach(skill => { workerSkills[skill] = 0; });

      // Apply activity's base_skills if available
      if (selectedActivityData && selectedActivityData.skills) {
        Object.assign(workerSkills, selectedActivityData.skills);
      }

      // Determine modality (single or first of multi)
      let modality = MODALITIES[0];  // default to first configured modality
      if (selectedActivityData) {
        if (selectedActivityData.modality) {
          modality = selectedActivityData.modality;
        } else if (selectedActivityData.modalities && selectedActivityData.modalities.length > 0) {
          modality = selectedActivityData.modalities[0];
        }
      }

      // Add worker for each modality if multi-modality activity
      const modalitiesToAdd = selectedActivityData?.modalities?.length > 0
        ? selectedActivityData.modalities
        : [modality];

      let successCount = 0;
      for (const mod of modalitiesToAdd) {
        try {
          const response = await fetch('/api/prep-next-day/add-worker', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              modality: mod,
              worker_data: {
                PPL: workerName,
                start_time: startTime,
                end_time: endTime,
                Modifier: 1.0,
                tasks: selectedTasks,
                activity: activitySelect.value,
                ...workerSkills
              }
            })
          });
          if (response.ok) successCount++;
        } catch (error) {
          console.log(`Error adding to ${mod}:`, error);
        }
      }

      if (successCount > 0) {
        const modStr = modalitiesToAdd.map(m => m.toUpperCase()).join(', ');
        showMessage('success', `Worker "${workerName}" added to ${modStr}`);
        // Reset form
        workerSelect.value = '';
        activitySelect.value = '';
        selectedActivityData = null;
        document.getElementById('activity-info').textContent = '';
        document.getElementById('custom-time-group').style.display = 'none';
        taskCheckboxes.forEach(cb => cb.checked = false);
        await loadData();  // Refresh table
      } else {
        showMessage('error', 'Failed to add worker');
      }
    }

    // Initialize
    loadData();
    loadSkillRosterWorkers();
  </script>
</body>
</html>
