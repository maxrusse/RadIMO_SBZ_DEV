<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Cortex | Schedule Edit</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f0f0; padding: 1rem; max-width: 1600px; margin: 0 auto; }
    .header { background: #004892; color: white; padding: 1rem 2rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .header-actions a, .header-actions button { color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .header-actions a:hover, .header-actions button:hover { background: rgba(255,255,255,0.3); }
    .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .info-box { background: #e7f3ff; border-left: 4px solid #004892; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.9rem; }
    .staging-banner { background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    .staging-banner h2 { color: #856404; margin-bottom: 0.5rem; font-size: 1.2rem; }
    .staging-banner p { color: #856404; margin: 0.25rem 0; font-size: 0.9rem; }
    .activate-section { background: #d1ecf1; border: 2px solid #0c5460; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    .activate-section h3 { color: #0c5460; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .btn-activate { background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
    .btn-activate:hover { background: #218838; }
    .mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .mode-toggle button { padding: 0.5rem 1rem; border: 2px solid #004892; background: white; color: #004892; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .mode-toggle button.active { background: #004892; color: white; }
    .modality-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
    .modality-tabs button { padding: 0.5rem 1rem; border: none; background: transparent; cursor: pointer; font-size: 0.9rem; font-weight: 600; border-bottom: 3px solid transparent; }
    .modality-tabs button.active { border-bottom-color: #004892; color: #004892; }
    .table-container { max-height: 500px; overflow: auto; }
    .edit-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .edit-table th, .edit-table td { padding: 0.4rem; text-align: left; border: 1px solid #ddd; }
    .edit-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
    .edit-table td[contenteditable="true"] { background: #fffbf0; cursor: text; }
    .edit-table td[contenteditable="true"]:hover { background: #fff4cc; }
    .edit-table td[contenteditable="true"]:focus { outline: 2px solid #004892; background: white; }
    .edit-table tr:hover { background: #f8f9fa; }
    .skill-cell { text-align: center; font-weight: 600; }
    .skill-1 { color: #28a745; background: #e6ffe6; }
    .skill-0 { color: #856404; background: #fff8e6; }
    .skill--1 { color: #dc3545; background: #ffe6e6; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .btn-primary { background: #004892; color: white; }
    .btn-primary:hover { background: #003670; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-small { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
    .message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
    .advanced-tools { display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; }
    .advanced-tools.visible { display: block; }
    .bulk-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>RadIMO Cortex | Schedule Edit</h1>
      <p style="font-size: 0.85rem; opacity: 0.9;">Edit schedule, then Activate to go live</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('skill_roster_page') }}">Skill Matrix</a>
      <a href="{{ url_for('upload_file') }}">Upload</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div id="message-container"></div>

  <div class="card" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
    <strong>Load from CSV:</strong>
    <button class="btn btn-primary" onclick="loadFromCSV('today')">Load Today</button>
    <button class="btn btn-primary" onclick="loadFromCSV('next')">Load Next Day</button>
    <span id="load-status" style="color: #666;"></span>
  </div>

  <div class="staging-banner">
    <h2>STAGING MODE - No Live Effect</h2>
    <p>Changes are saved to STAGED area. Use "Activate" to apply to live schedule.</p>
  </div>

  <div class="activate-section">
    <h3>Activate Staged Schedule</h3>
    <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">This copies Staged → Live and resets all counters!</p>
    <button class="btn-activate" onclick="activateStagedSchedule()">
      ACTIVATE (Staged → Live)
    </button>
  </div>

  <div class="card">
    <div class="info-box">
      <strong>Next Day Editing (Staging)</strong> - Adjust tomorrow's schedule here. Changes saved to STAGED area.
    </div>

    <div class="mode-toggle">
      <button id="mode-simple" class="active" onclick="setMode('simple')">Simple (Edit Cells)</button>
      <button id="mode-advanced" onclick="setMode('advanced')">Advanced (Add/Delete)</button>
    </div>

    <div class="modality-tabs">
      <span style="margin-right: 0.5rem; font-weight: 600; color: #666;">Filter:</span>
      <button class="active" onclick="setFilter('all')">ALL</button>
      {% for mod in modalities %}
      <button onclick="setFilter('{{ mod }}')">{{ mod|upper }}</button>
      {% endfor %}
    </div>

    <div class="table-container">
      <table class="edit-table" id="edit-table">
        <thead>
          <tr>
            <th>Worker</th>
            <th>Modality</th>
            <th>Von</th>
            <th>Bis</th>
            {% for skill in skills %}
            <th>{{ skill }}</th>
            {% endfor %}
            <th>Mod</th>
            <th id="actions-header" style="display:none;">Actions</th>
          </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
      </table>
    </div>

    <div id="advanced-tools" class="advanced-tools">
      <h4 style="margin-bottom: 0.5rem;">Advanced Tools</h4>
      <div class="bulk-actions">
        <button class="btn btn-success" onclick="addWorkerRow()">+ Add Worker</button>
        <button class="btn btn-primary" onclick="bulkSetSkill()">Bulk Set Skill</button>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <button class="btn btn-success" onclick="saveAllChanges()" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
        Save All Changes
      </button>
      <span id="save-status" style="margin-left: 1rem; color: #666;"></span>
    </div>
  </div>

  <script>
    // Dynamic configuration from backend
    const SKILLS = {{ skills|tojson }};
    const MODALITIES = {{ modalities|tojson }};

    let currentFilter = 'all';  // Filter: 'all' or specific modality
    let currentMode = 'simple';
    let tableData = {};  // {modality: [rows]}
    let allData = [];    // Combined data from all modalities
    let pendingChanges = {};

    async function loadData() {
      try {
        const response = await fetch('/api/prep-next-day/data');
        const data = await response.json();
        tableData = data;

        // Combine all modalities into unified list
        allData = [];
        MODALITIES.forEach(mod => {
          const modData = tableData[mod] || [];
          modData.forEach(row => {
            allData.push({ ...row, _modality: mod });
          });
        });

        renderTable();
      } catch (error) {
        showMessage('error', `Error loading: ${error.message}`);
      }
    }

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('mode-simple').classList.toggle('active', mode === 'simple');
      document.getElementById('mode-advanced').classList.toggle('active', mode === 'advanced');
      document.getElementById('advanced-tools').classList.toggle('visible', mode === 'advanced');
      document.getElementById('actions-header').style.display = mode === 'advanced' ? '' : 'none';
      renderTable();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.modality-tabs button').forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        btn.classList.toggle('active', btnText === filter);
      });
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      // Filter data based on current filter
      let data = allData;
      if (currentFilter !== 'all') {
        data = allData.filter(row => row._modality === currentFilter);
      }

      if (data.length === 0) {
        const colSpan = 5 + SKILLS.length + (currentMode === 'advanced' ? 1 : 0);
        tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align: center; padding: 2rem; color: #666;">No data. Upload CSV first.</td></tr>`;
        return;
      }

      data.forEach((row) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = row.row_index;
        tr.dataset.modality = row._modality;

        // Worker name
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="PPL">${row.PPL}</td>`;
        // Modality (always visible, editable via dropdown in advanced mode later)
        tr.innerHTML += `<td style="font-weight: bold; text-transform: uppercase;">${row._modality}</td>`;
        // Times
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="start_time">${row.start_time}</td>`;
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="end_time">${row.end_time}</td>`;

        // Skills
        SKILLS.forEach(skill => {
          const value = row[skill] !== undefined ? row[skill] : 0;
          const className = `skill-cell skill-${value}`;
          tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="${skill}" class="${className}">${value}</td>`;
        });

        // Modifier
        tr.innerHTML += `<td contenteditable="${currentMode === 'simple'}" data-col="Modifier">${row.Modifier || 1.0}</td>`;

        // Actions (advanced mode)
        if (currentMode === 'advanced') {
          tr.innerHTML += `<td><button class="btn btn-danger btn-small" onclick="deleteWorkerRow('${row._modality}', ${row.row_index})">Del</button></td>`;
        }

        tbody.appendChild(tr);
      });

      // Add event listeners
      document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('blur', handleCellEdit);
      });
    }

    function handleCellEdit(event) {
      const cell = event.target;
      const row = cell.parentElement;
      const rowIndex = parseInt(row.dataset.rowIndex);
      const rowModality = row.dataset.modality;  // Always use row's modality
      const col = cell.dataset.col;
      const newValue = cell.textContent.trim();

      if (!pendingChanges[rowModality]) pendingChanges[rowModality] = {};
      if (!pendingChanges[rowModality][rowIndex]) pendingChanges[rowModality][rowIndex] = {};
      pendingChanges[rowModality][rowIndex][col] = newValue;

      const dataRow = tableData[rowModality]?.find(r => r.row_index === rowIndex);
      if (dataRow) dataRow[col] = newValue;

      cell.style.background = '#d4edda';
      setTimeout(() => { cell.style.background = ''; }, 500);
    }

    async function saveAllChanges() {
      const saveStatus = document.getElementById('save-status');
      saveStatus.textContent = 'Saving...';
      let successCount = 0, errorCount = 0;

      for (const modality in pendingChanges) {
        for (const rowIndex in pendingChanges[modality]) {
          try {
            const response = await fetch('/api/prep-next-day/update-row', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ modality, row_index: parseInt(rowIndex), updates: pendingChanges[modality][rowIndex] })
            });
            response.ok ? successCount++ : errorCount++;
          } catch { errorCount++; }
        }
      }

      pendingChanges = {};
      saveStatus.textContent = errorCount === 0 ? `${successCount} saved` : `${successCount} saved, ${errorCount} errors`;
      saveStatus.style.color = errorCount === 0 ? '#28a745' : '#dc3545';
      showMessage(errorCount === 0 ? 'success' : 'error', saveStatus.textContent);
      setTimeout(() => { saveStatus.textContent = ''; }, 3000);
    }

    async function addWorkerRow() {
      // Always ask which modality (use current filter as default if it's a specific modality)
      const defaultMod = currentFilter !== 'all' ? currentFilter : MODALITIES[0];
      let targetModality = prompt(`Which modality? (${MODALITIES.join(', ')}):`, defaultMod);
      if (!targetModality || !MODALITIES.includes(targetModality.toLowerCase())) {
        showMessage('error', 'Invalid modality');
        return;
      }
      targetModality = targetModality.toLowerCase();

      const workerName = prompt('Worker Name:', 'New Worker');
      if (!workerName) return;

      const defaultSkills = {};
      SKILLS.forEach((skill, i) => { defaultSkills[skill] = i < 2 ? 1 : 0; });

      try {
        const response = await fetch('/api/prep-next-day/add-worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            modality: targetModality,
            worker_data: { PPL: workerName, start_time: '07:00', end_time: '15:00', Modifier: 1.0, ...defaultSkills }
          })
        });
        if (response.ok) { showMessage('success', `Worker "${workerName}" added to ${targetModality.toUpperCase()}`); await loadData(); }
        else showMessage('error', 'Failed to add');
      } catch (error) { showMessage('error', error.message); }
    }

    async function deleteWorkerRow(modality, rowIndex) {
      if (!confirm('Delete this worker?')) return;
      try {
        const response = await fetch('/api/prep-next-day/delete-worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modality: modality, row_index: rowIndex })
        });
        if (response.ok) { showMessage('success', 'Deleted'); await loadData(); }
        else showMessage('error', 'Failed');
      } catch (error) { showMessage('error', error.message); }
    }

    function bulkSetSkill() {
      const skillList = SKILLS.join(', ');
      const skill = prompt(`Skill Name (${skillList}):`, SKILLS[0]);
      if (!skill || !SKILLS.includes(skill)) { alert('Invalid skill'); return; }

      const value = prompt(`Value for ${skill} (-1=excluded, 0=passive, 1=active):`, '1');
      if (value === null) return;
      const parsedValue = parseInt(value);
      if (![-1, 0, 1].includes(parsedValue)) { alert('Invalid value! Use -1, 0, or 1'); return; }

      // Apply to all visible (filtered) workers
      const targetData = currentFilter === 'all' ? allData : allData.filter(r => r._modality === currentFilter);
      targetData.forEach(row => {
        row[skill] = parsedValue;
        if (!pendingChanges[row._modality]) pendingChanges[row._modality] = {};
        if (!pendingChanges[row._modality][row.row_index]) pendingChanges[row._modality][row.row_index] = {};
        pendingChanges[row._modality][row.row_index][skill] = parsedValue;
      });

      renderTable();
      showMessage('success', `Set ${skill}=${parsedValue} for ${targetData.length} workers`);
    }

    async function loadFromCSV(mode) {
      const loadStatus = document.getElementById('load-status');
      loadStatus.textContent = 'Loading...';

      const endpoint = mode === 'today' ? '/load-today-from-master' : '/preload-from-master';
      try {
        const response = await fetch(endpoint, { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
          loadStatus.textContent = result.message || 'Loaded!';
          loadStatus.style.color = '#28a745';
          await loadData();  // Refresh table
        } else {
          loadStatus.textContent = result.error || 'Error';
          loadStatus.style.color = '#dc3545';
          if (result.debug) {
            console.log('Debug:', result.debug);
          }
        }
      } catch (error) {
        loadStatus.textContent = 'Error: ' + error.message;
        loadStatus.style.color = '#dc3545';
      }

      setTimeout(() => { loadStatus.textContent = ''; }, 5000);
    }

    function showMessage(type, message) {
      const container = document.getElementById('message-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    async function activateStagedSchedule() {
      if (!confirm('WARNING!\n\nThis copies STAGED → LIVE and resets all counters!\n\nContinue?')) return;
      if (!confirm('Final confirmation: All assignment counters will be reset. Activate?')) return;

      try {
        const response = await fetch('/api/prep-next-day/activate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modalities: MODALITIES })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('success', `Activated! Modalities: ${result.activated_modalities.join(', ')}, Workers: ${result.total_workers}`);
        } else {
          showMessage('error', result.error || 'Unknown error');
        }
      } catch (error) { showMessage('error', error.message); }
    }

    loadData();
  </script>
</body>
</html>
