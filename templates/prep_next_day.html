<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Cortex | Change Today / Prep Tomorrow</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f0f0; padding: 1rem; max-width: 1800px; margin: 0 auto; }
    .header { background: #004892; color: white; padding: 1rem 2rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .header-actions a, .header-actions button { color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .header-actions a:hover, .header-actions button:hover { background: rgba(255,255,255,0.3); }
    .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }

    /* Tab Styles */
    .tab-container { display: flex; gap: 0; margin-bottom: 0; }
    .tab-btn { padding: 1rem 2rem; border: none; background: #e0e0e0; color: #666; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab-btn:hover { background: #d0d0d0; }
    .tab-btn.active-today { background: #28a745; color: white; }
    .tab-btn.active-tomorrow { background: #ffc107; color: #333; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Today Banner - Green */
    .today-banner { background: #d4edda; border: 2px solid #28a745; padding: 1rem; border-radius: 0 8px 8px 8px; margin-bottom: 1rem; }
    .today-banner h2 { color: #155724; margin-bottom: 0.5rem; font-size: 1.2rem; }
    .today-banner p { color: #155724; margin: 0.25rem 0; font-size: 0.9rem; }

    /* Tomorrow Banner - Yellow */
    .tomorrow-banner { background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 0 8px 8px 8px; margin-bottom: 1rem; }
    .tomorrow-banner h2 { color: #856404; margin-bottom: 0.5rem; font-size: 1.2rem; }
    .tomorrow-banner p { color: #856404; margin: 0.25rem 0; font-size: 0.9rem; }

    /* Table Styles */
    .table-container { max-height: 600px; overflow: auto; }
    .edit-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .edit-table th, .edit-table td { padding: 0.5rem; text-align: left; border: 1px solid #ddd; vertical-align: top; }
    .edit-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
    .edit-table tr:hover { background: #f8f9fa; }

    /* Badges */
    .badge { display: inline-block; padding: 0.2rem 0.4rem; margin: 0.1rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600; }
    .badge-ct { background: #17a2b8; color: white; }
    .badge-mr { background: #6f42c1; color: white; }
    .badge-xray { background: #fd7e14; color: white; }
    .badge-mammo { background: #e83e8c; color: white; }
    .badge-default { background: #6c757d; color: white; }

    /* Shift display */
    .shift-item { display: block; font-size: 0.75rem; padding: 0.15rem 0; border-bottom: 1px dotted #ddd; }
    .shift-item:last-child { border-bottom: none; }
    .shift-modality { font-weight: 600; color: #666; }

    /* Skill cells */
    .skill-cell { text-align: center; font-size: 0.7rem; }
    .skill-values { display: flex; flex-direction: column; gap: 0.1rem; }
    .skill-val { padding: 0.1rem 0.2rem; border-radius: 2px; }
    .skill-val-1 { background: #d4edda; color: #155724; }
    .skill-val-0 { background: #fff3cd; color: #856404; }
    .skill-val--1 { background: #f8d7da; color: #721c24; }

    /* Task badges */
    .task-badge { display: inline-block; padding: 0.15rem 0.4rem; margin: 0.1rem; border-radius: 3px; font-size: 0.7rem; background: #e9ecef; color: #495057; }
    .task-badge.exclusion { background: #f8d7da; color: #721c24; }

    /* Buttons */
    .btn { padding: 0.4rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
    .btn-primary { background: #004892; color: white; }
    .btn-primary:hover { background: #003670; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-small { padding: 0.2rem 0.4rem; font-size: 0.7rem; }

    /* Message */
    .message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }

    /* Add Panel */
    .add-panel { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #28a745; }
    .add-panel.tomorrow { border-color: #ffc107; }
    .add-panel h4 { margin: 0 0 0.75rem 0; color: #28a745; font-size: 1rem; }
    .add-panel.tomorrow h4 { color: #856404; }
    .add-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; }
    .add-row .form-group { display: flex; flex-direction: column; }
    .add-row .form-group label { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #666; }
    .add-row select, .add-row input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal h3 { margin: 0 0 1rem 0; }
    .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }

    /* Dropdown select */
    .worker-select { padding: 0.3rem; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8rem; max-width: 150px; }

    /* Action buttons cell */
    .action-cell { white-space: nowrap; }
    .action-cell .btn { margin: 0.1rem; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>RadIMO Cortex | Change Today / Prep Tomorrow</h1>
      <p style="font-size: 0.85rem; opacity: 0.9;">Manage current schedule or prepare tomorrow's schedule</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('skill_roster_page') }}">Skill Matrix</a>
      <a href="{{ url_for('upload_file') }}">Upload</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div id="message-container"></div>

  <!-- Tab Navigation -->
  <div class="tab-container">
    <button class="tab-btn active-today" onclick="switchTab('today')" id="tab-today">Change Today</button>
    <button class="tab-btn" onclick="switchTab('tomorrow')" id="tab-tomorrow">Prep Tomorrow</button>
  </div>

  <!-- TODAY TAB -->
  <div id="content-today" class="tab-content active">
    <div class="today-banner">
      <h2>LIVE CHANGES - Immediate Effect</h2>
      <p>Changes here apply IMMEDIATELY to today's schedule. <strong>Counters are NOT reset.</strong></p>
    </div>

    <div class="card" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
      <strong>Load Today from CSV:</strong>
      <button class="btn btn-success" onclick="loadFromCSV('today')">Load Today</button>
      <span id="load-status-today" style="color: #666;"></span>
    </div>

    <div class="card">
      <!-- Add Worker Panel -->
      <div class="add-panel">
        <h4>+ Add Worker</h4>
        <div class="add-row">
          <div class="form-group">
            <label>Worker</label>
            <select id="add-worker-today" style="min-width: 180px;">
              <option value="">-- Select Worker --</option>
              {% for worker in worker_list %}
              <option value="{{ worker }}">{{ worker }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Task/Role</label>
            <select id="add-task-today" onchange="onTaskChange('today')" style="min-width: 180px;">
              <option value="">-- Select Task --</option>
              {% for task in task_roles|default([]) %}
              <option value="{{ task.name }}" data-modalities="{{ task.modalities|tojson }}" data-shift="{{ task.shift }}" data-skills="{{ task.base_skills|tojson }}">{{ task.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group" id="modality-select-today" style="display: none;">
            <label>Modality</label>
            <select id="add-modality-today">
              {% for mod in modalities %}
              <option value="{{ mod }}">{{ mod|upper }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Shift</label>
            <select id="add-shift-today" style="min-width: 150px;">
              {% for shift_name, shift_data in shift_times.items() %}
              <option value="{{ shift_name }}" data-default="{{ shift_data.get('default', '07:00-15:00') }}">{{ shift_name }} ({{ shift_data.get('default', '') }})</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-success" onclick="addWorker('today')">Add</button>
        </div>
      </div>

      <!-- Worker Table -->
      <div class="table-container">
        <table class="edit-table">
          <thead>
            <tr>
              <th>Worker</th>
              <th>Modalities</th>
              <th>Shifts</th>
              {% for skill in skills %}
              <th class="skill-cell">{{ skill }}</th>
              {% endfor %}
              <th>Tasks / Gaps</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="table-body-today"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TOMORROW TAB -->
  <div id="content-tomorrow" class="tab-content">
    <div class="tomorrow-banner">
      <h2>STAGING MODE - Prep for Tomorrow</h2>
      <p>Changes are saved to STAGED area for tomorrow. <strong>Counter reset happens on CSV import.</strong></p>
    </div>

    <div class="card" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
      <strong>Load Next Day from CSV:</strong>
      <button class="btn btn-warning" onclick="loadFromCSV('next')">Load Next Day</button>
      <span id="load-status-tomorrow" style="color: #666;"></span>
    </div>

    <div class="card">
      <!-- Add Worker Panel -->
      <div class="add-panel tomorrow">
        <h4>+ Add Worker</h4>
        <div class="add-row">
          <div class="form-group">
            <label>Worker Name</label>
            <input type="text" id="add-worker-input" placeholder="e.g. Dr. Müller" style="width: 200px;" list="worker-list-datalist" autocomplete="off">
            <datalist id="worker-list-datalist">
              {% for worker in worker_list %}
              <option value="{{ worker }}">
              {% endfor %}
            </datalist>
          </div>
          <div class="form-group">
            <label>Task/Role</label>
            <select id="add-task-tomorrow" onchange="onTaskChange('tomorrow')" style="min-width: 180px;">
              <option value="">-- Select Task --</option>
              {% for task in task_roles|default([]) %}
              <option value="{{ task.name }}" data-modalities="{{ task.modalities|tojson }}" data-shift="{{ task.shift }}" data-skills="{{ task.base_skills|tojson }}">{{ task.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group" id="modality-select-tomorrow" style="display: none;">
            <label>Modality</label>
            <select id="add-modality-tomorrow">
              {% for mod in modalities %}
              <option value="{{ mod }}">{{ mod|upper }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Shift</label>
            <select id="add-shift-tomorrow" style="min-width: 150px;">
              {% for shift_name, shift_data in shift_times.items() %}
              <option value="{{ shift_name }}" data-default="{{ shift_data.get('default', '07:00-15:00') }}">{{ shift_name }} ({{ shift_data.get('default', '') }})</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-warning" onclick="addWorker('tomorrow')">Add</button>
        </div>
      </div>

      <!-- Worker Table -->
      <div class="table-container">
        <table class="edit-table">
          <thead>
            <tr>
              <th>Worker</th>
              <th>Modalities</th>
              <th>Shifts</th>
              {% for skill in skills %}
              <th class="skill-cell">{{ skill }}</th>
              {% endfor %}
              <th>Tasks / Gaps</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="table-body-tomorrow"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="edit-modal">
    <div class="modal">
      <h3 id="modal-title">Edit Worker</h3>
      <div id="modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveModalChanges()">Save</button>
      </div>
    </div>
  </div>

  <!-- Gap Modal -->
  <div class="modal-overlay" id="gap-modal">
    <div class="modal">
      <h3>Add Gap / Exclusion</h3>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Gap Type:</label>
        <select id="gap-type-select" onchange="onGapTypeSelect()" style="width: 100%; padding: 0.5rem;">
          <option value="custom">Custom Time</option>
          {% for rule in exclusion_rules|default([]) %}
          <option value="{{ rule.match }}" data-schedule="{{ rule.schedule|tojson if rule.schedule else '{}' }}">{{ rule.match }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Time:</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="time" id="gap-start" value="12:00" style="padding: 0.5rem;">
          <span>-</span>
          <input type="time" id="gap-end" value="13:00" style="padding: 0.5rem;">
        </div>
      </div>
      <input type="hidden" id="gap-worker-key">
      <input type="hidden" id="gap-tab">
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeGapModal()">Cancel</button>
        <button class="btn btn-danger" onclick="saveGap()">Add Gap</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration from backend
    const SKILLS = {{ skills|default([])|tojson }};
    const MODALITIES = {{ modalities|default([])|tojson }};
    const SHIFT_TIMES = {{ shift_times|default({})|tojson }};
    const WORKER_SKILLS = {{ worker_skills|default({})|tojson }};
    const TASK_ROLES = {{ task_roles|default([])|tojson }};
    const EXCLUSION_RULES = {{ exclusion_rules|default([])|tojson }};

    // State
    let currentTab = 'today';
    let rawData = { today: {}, tomorrow: {} };  // Raw modality data
    let groupedData = { today: {}, tomorrow: {} };  // Grouped by worker
    let currentEditWorker = null;

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tab-today').className = tab === 'today' ? 'tab-btn active-today' : 'tab-btn';
      document.getElementById('tab-tomorrow').className = tab === 'tomorrow' ? 'tab-btn active-tomorrow' : 'tab-btn';
      document.getElementById('content-today').className = tab === 'today' ? 'tab-content active' : 'tab-content';
      document.getElementById('content-tomorrow').className = tab === 'tomorrow' ? 'tab-content active' : 'tab-content';
    }

    // Load and group data
    async function loadData() {
      try {
        // Load today's LIVE data
        const todayResponse = await fetch('/api/live-schedule/data');
        rawData.today = await todayResponse.json();
        groupedData.today = groupByWorker(rawData.today);

        // Load tomorrow's STAGED data
        const tomorrowResponse = await fetch('/api/prep-next-day/data');
        rawData.tomorrow = await tomorrowResponse.json();
        groupedData.tomorrow = groupByWorker(rawData.tomorrow);

        renderTable('today');
        renderTable('tomorrow');
      } catch (error) {
        showMessage('error', `Error loading data: ${error.message}`);
      }
    }

    // Group rows by worker (PPL) - one row per worker with all their shifts/modalities
    function groupByWorker(data) {
      const workers = {};

      MODALITIES.forEach(mod => {
        const modData = data[mod] || [];
        modData.forEach(row => {
          const workerName = row.PPL;
          if (!workers[workerName]) {
            workers[workerName] = {
              name: workerName,
              entries: [],  // All shift entries
              modalities: new Set(),
              tasks: new Set()
            };
          }

          workers[workerName].entries.push({
            modality: mod,
            row_index: row.row_index,
            start_time: row.start_time,
            end_time: row.end_time,
            skills: SKILLS.reduce((acc, skill) => {
              acc[skill] = row[skill] !== undefined ? row[skill] : 0;
              return acc;
            }, {}),
            tasks: row.tasks || ''
          });

          workers[workerName].modalities.add(mod);

          // Parse tasks - handle both string and array formats
          let taskStr = row.tasks || '';
          if (Array.isArray(taskStr)) {
            taskStr.forEach(t => {
              if (t && t.trim()) workers[workerName].tasks.add(t.trim());
            });
          } else if (typeof taskStr === 'string' && taskStr) {
            taskStr.split(',').map(t => t.trim()).filter(t => t).forEach(t => {
              workers[workerName].tasks.add(t);
            });
          }
        });
      });

      return workers;
    }

    // Render grouped table
    function renderTable(tab) {
      const tbody = document.getElementById(`table-body-${tab}`);
      tbody.innerHTML = '';

      const workers = groupedData[tab];
      const workerNames = Object.keys(workers).sort();

      if (workerNames.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${6 + SKILLS.length}" style="text-align: center; padding: 2rem; color: #666;">No data. Load from CSV first.</td></tr>`;
        return;
      }

      workerNames.forEach(workerName => {
        const worker = workers[workerName];
        const tr = document.createElement('tr');

        // Worker name (dropdown to change)
        tr.innerHTML += `
          <td>
            <select class="worker-select" data-worker="${workerName}" onchange="changeWorkerName('${tab}', '${workerName}', this.value)">
              <option value="${workerName}" selected>${workerName}</option>
              ${Object.keys(WORKER_SKILLS).filter(w => w !== workerName && !workers[w]).map(w =>
                `<option value="${w}">${w}</option>`
              ).join('')}
            </select>
          </td>`;

        // Modalities (badges)
        const modBadges = Array.from(worker.modalities).map(mod => {
          const badgeClass = `badge-${mod}` || 'badge-default';
          return `<span class="badge ${badgeClass}">${mod.toUpperCase()}</span>`;
        }).join('');
        tr.innerHTML += `<td>${modBadges}</td>`;

        // Shifts (grouped by modality)
        const shiftsHtml = worker.entries.map(e => {
          return `<span class="shift-item"><span class="shift-modality">${e.modality.toUpperCase()}:</span> ${e.start_time}-${e.end_time}</span>`;
        }).join('');
        tr.innerHTML += `<td>${shiftsHtml}</td>`;

        // Skills (show value per modality entry)
        SKILLS.forEach(skill => {
          const skillVals = worker.entries.map(e => {
            const val = e.skills[skill];
            const valClass = `skill-val-${val}`;
            return `<span class="skill-val ${valClass}" title="${e.modality.toUpperCase()}">${val}</span>`;
          }).join('');
          tr.innerHTML += `<td class="skill-cell"><div class="skill-values">${skillVals}</div></td>`;
        });

        // Tasks (badges with edit button)
        const taskBadges = Array.from(worker.tasks).map(t => {
          const isExclusion = EXCLUSION_RULES.some(r => r.match === t);
          return `<span class="task-badge ${isExclusion ? 'exclusion' : ''}">${t}</span>`;
        }).join('') || '<span style="color: #999; font-size: 0.75rem;">No tasks</span>';
        tr.innerHTML += `<td>${taskBadges} <button class="btn btn-small btn-secondary" onclick="editTasks('${tab}', '${workerName}')">Edit</button></td>`;

        // Actions
        tr.innerHTML += `
          <td class="action-cell">
            <button class="btn btn-small btn-warning" onclick="openGapModal('${tab}', '${workerName}')" title="Add Gap">+Gap</button>
            <button class="btn btn-small btn-danger" onclick="deleteWorker('${tab}', '${workerName}')" title="Delete">Del</button>
          </td>`;

        tbody.appendChild(tr);
      });
    }

    // Task dropdown change - auto-select modality and shift
    function onTaskChange(tab) {
      const taskSelect = document.getElementById(`add-task-${tab}`);
      const modalityGroup = document.getElementById(`modality-select-${tab}`);
      const modalitySelect = document.getElementById(`add-modality-${tab}`);
      const shiftSelect = document.getElementById(`add-shift-${tab}`);

      const option = taskSelect.options[taskSelect.selectedIndex];
      if (!option || !option.value) {
        modalityGroup.style.display = 'none';
        return;
      }

      // Get modalities from data attribute
      const modalities = JSON.parse(option.dataset.modalities || '[]');
      const shift = option.dataset.shift;

      // Show modality dropdown if multiple options
      if (modalities.length > 1) {
        modalityGroup.style.display = 'block';
        modalitySelect.innerHTML = modalities.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
      } else if (modalities.length === 1) {
        modalityGroup.style.display = 'none';
        modalitySelect.innerHTML = `<option value="${modalities[0]}">${modalities[0].toUpperCase()}</option>`;
      }

      // Auto-select shift
      if (shift && SHIFT_TIMES[shift]) {
        shiftSelect.value = shift;
      }
    }

    // Add worker
    async function addWorker(tab) {
      const workerSelect = document.getElementById(`add-worker-${tab}`);
      const taskSelect = document.getElementById(`add-task-${tab}`);
      const modalitySelect = document.getElementById(`add-modality-${tab}`);
      const shiftSelect = document.getElementById(`add-shift-${tab}`);

      const workerName = workerSelect.value;
      const taskName = taskSelect.value;
      const modality = modalitySelect.value;
      const shiftOption = shiftSelect.options[shiftSelect.selectedIndex];

      if (!workerName) { showMessage('error', 'Please select a worker'); return; }
      if (!taskName) { showMessage('error', 'Please select a task/role'); return; }

      // Get times from shift
      const shiftDefault = shiftOption.dataset.default || '07:00-15:00';
      const [startTime, endTime] = shiftDefault.split('-');

      // Get skills from task
      const taskOption = taskSelect.options[taskSelect.selectedIndex];
      const taskSkills = JSON.parse(taskOption.dataset.skills || '{}');

      const endpoint = tab === 'today' ? '/api/live-schedule/add-worker' : '/api/prep-next-day/add-worker';

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            modality,
            worker_data: {
              PPL: workerName,
              start_time: startTime,
              end_time: endTime,
              Modifier: 1.0,
              tasks: taskName,
              ...SKILLS.reduce((acc, skill) => {
                acc[skill] = taskSkills[skill] !== undefined ? taskSkills[skill] : 0;
                return acc;
              }, {})
            }
          })
        });

        if (response.ok) {
          showMessage('success', `${workerName} added as ${taskName}`);
          workerSelect.value = '';
          taskSelect.value = '';
          document.getElementById(`modality-select-${tab}`).style.display = 'none';
          await loadData();
        } else {
          showMessage('error', 'Failed to add worker');
        }
      } catch (error) {
        showMessage('error', error.message);
      }
    }

    // Change worker name (rename all entries)
    async function changeWorkerName(tab, oldName, newName) {
      if (oldName === newName) return;

      const worker = groupedData[tab][oldName];
      if (!worker) return;

      const endpoint = tab === 'today' ? '/api/live-schedule/update-row' : '/api/prep-next-day/update-row';

      try {
        // Update all entries for this worker
        for (const entry of worker.entries) {
          await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              modality: entry.modality,
              row_index: entry.row_index,
              updates: { PPL: newName }
            })
          });
        }
        showMessage('success', `Renamed ${oldName} to ${newName}`);
        await loadData();
      } catch (error) {
        showMessage('error', error.message);
        await loadData();  // Reload to reset dropdown
      }
    }

    // Delete worker (all entries)
    async function deleteWorker(tab, workerName) {
      if (!confirm(`Delete all entries for ${workerName}?`)) return;

      const worker = groupedData[tab][workerName];
      if (!worker) return;

      const endpoint = tab === 'today' ? '/api/live-schedule/delete-worker' : '/api/prep-next-day/delete-worker';

      try {
        // Delete entries in reverse order (highest index first) to avoid index shifting issues
        const entries = [...worker.entries].sort((a, b) => b.row_index - a.row_index);
        for (const entry of entries) {
          await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ modality: entry.modality, row_index: entry.row_index })
          });
        }
        showMessage('success', `Deleted ${workerName}`);
        await loadData();
      } catch (error) {
        showMessage('error', error.message);
      }
    }

    // Edit tasks modal
    function editTasks(tab, workerName) {
      currentEditWorker = { tab, workerName };
      const worker = groupedData[tab][workerName];

      let html = '<div style="margin-bottom: 1rem;">';
      html += '<label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Current Tasks:</label>';
      html += '<div id="current-tasks">';
      worker.tasks.forEach(task => {
        html += `<span class="task-badge" style="margin: 0.2rem;">${task} <span style="cursor: pointer; color: #dc3545;" onclick="removeTask('${task}')">&times;</span></span>`;
      });
      if (worker.tasks.size === 0) {
        html += '<span style="color: #999;">No tasks</span>';
      }
      html += '</div></div>';

      html += '<div style="margin-bottom: 1rem;">';
      html += '<label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Add Task:</label>';
      html += '<select id="add-task-modal" style="width: 100%; padding: 0.5rem;">';
      html += '<option value="">-- Select Task --</option>';
      TASK_ROLES.forEach(task => {
        if (!worker.tasks.has(task.name)) {
          html += `<option value="${task.name}">${task.name}</option>`;
        }
      });
      html += '</select>';
      html += '</div>';

      document.getElementById('modal-title').textContent = `Edit Tasks - ${workerName}`;
      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('edit-modal').classList.add('show');
    }

    function removeTask(taskName) {
      const tasksDiv = document.getElementById('current-tasks');
      const badges = tasksDiv.querySelectorAll('.task-badge');
      badges.forEach(badge => {
        if (badge.textContent.includes(taskName)) {
          badge.remove();
        }
      });
      if (tasksDiv.children.length === 0) {
        tasksDiv.innerHTML = '<span style="color: #999;">No tasks</span>';
      }
    }

    async function saveModalChanges() {
      if (!currentEditWorker) return;

      const { tab, workerName } = currentEditWorker;
      const worker = groupedData[tab][workerName];

      // Get current tasks from modal
      const tasksDiv = document.getElementById('current-tasks');
      const badges = tasksDiv.querySelectorAll('.task-badge');
      const tasks = Array.from(badges).map(b => b.textContent.replace('×', '').trim());

      // Add newly selected task
      const addTaskSelect = document.getElementById('add-task-modal');
      if (addTaskSelect && addTaskSelect.value) {
        tasks.push(addTaskSelect.value);
      }

      const endpoint = tab === 'today' ? '/api/live-schedule/update-row' : '/api/prep-next-day/update-row';

      try {
        // Update first entry with tasks (tasks are shared across all entries)
        if (worker.entries.length > 0) {
          const entry = worker.entries[0];
          await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              modality: entry.modality,
              row_index: entry.row_index,
              updates: { tasks: tasks.join(', ') }
            })
          });
        }
        closeModal();
        showMessage('success', 'Tasks updated');
        await loadData();
      } catch (error) {
        showMessage('error', error.message);
      }
    }

    function closeModal() {
      document.getElementById('edit-modal').classList.remove('show');
      currentEditWorker = null;
    }

    // Gap modal
    function openGapModal(tab, workerName) {
      document.getElementById('gap-worker-key').value = workerName;
      document.getElementById('gap-tab').value = tab;
      document.getElementById('gap-type-select').value = 'custom';
      document.getElementById('gap-start').value = '12:00';
      document.getElementById('gap-end').value = '13:00';
      document.getElementById('gap-modal').classList.add('show');
    }

    function onGapTypeSelect() {
      const select = document.getElementById('gap-type-select');
      const option = select.options[select.selectedIndex];

      if (option.value !== 'custom' && option.dataset.schedule) {
        const schedule = JSON.parse(option.dataset.schedule);
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const today = days[new Date().getDay()];

        if (schedule[today]) {
          const [start, end] = schedule[today].split('-');
          document.getElementById('gap-start').value = start;
          document.getElementById('gap-end').value = end;
        }
      }
    }

    async function saveGap() {
      const workerName = document.getElementById('gap-worker-key').value;
      const tab = document.getElementById('gap-tab').value;
      const gapType = document.getElementById('gap-type-select').value;
      const gapStart = document.getElementById('gap-start').value;
      const gapEnd = document.getElementById('gap-end').value;

      const worker = groupedData[tab][workerName];
      if (!worker || worker.entries.length === 0) {
        showMessage('error', 'Worker not found');
        return;
      }

      // Apply gap to first entry (or could be all entries)
      const entry = worker.entries[0];
      const endpoint = tab === 'today' ? '/api/live-schedule/add-gap' : '/api/prep-next-day/add-gap';

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            modality: entry.modality,
            row_index: entry.row_index,
            gap_type: gapType,
            gap_start: gapStart,
            gap_end: gapEnd
          })
        });

        if (response.ok) {
          closeGapModal();
          showMessage('success', `Gap added to ${workerName}`);
          await loadData();
        } else {
          const result = await response.json();
          showMessage('error', result.error || 'Failed to add gap');
        }
      } catch (error) {
        showMessage('error', error.message);
      }
    }

    function closeGapModal() {
      document.getElementById('gap-modal').classList.remove('show');
    }

    // Load from CSV
    async function loadFromCSV(mode) {
      const statusId = mode === 'today' ? 'load-status-today' : 'load-status-tomorrow';
      const loadStatus = document.getElementById(statusId);
      loadStatus.textContent = 'Loading...';

      const endpoint = mode === 'today' ? '/load-today-from-master' : '/preload-from-master';

      try {
        const response = await fetch(endpoint, { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
          loadStatus.textContent = result.message || 'Loaded!';
          loadStatus.style.color = '#28a745';
          await loadData();
        } else {
          loadStatus.textContent = result.error || 'Error';
          loadStatus.style.color = '#dc3545';
        }
      } catch (error) {
        loadStatus.textContent = 'Error: ' + error.message;
        loadStatus.style.color = '#dc3545';
      }

      setTimeout(() => { loadStatus.textContent = ''; }, 5000);
    }

    // Show message
    function showMessage(type, message) {
      const container = document.getElementById('message-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
