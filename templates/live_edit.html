<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Cortex | Day Control</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f0f0; padding: 1rem; max-width: 1600px; margin: 0 auto; }
    .header { background: #004892; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .header-actions a, .header-actions button { color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .header-actions a:hover, .header-actions button:hover { background: rgba(255,255,255,0.3); }
    .warning-banner { background: #fff3cd; border: 2px solid #ff9800; border-left: 6px solid #ff6b00; padding: 1rem 1.5rem; border-radius: 4px; margin-bottom: 1rem; font-weight: 600; color: #856404; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
    .btn-primary { background: #004892; color: white; }
    .btn-primary:hover { background: #003670; }
    .btn-secondary { background: #777; color: white; }
    .btn-secondary:hover { background: #555; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.85rem; }
    .modality-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .modality-tab { padding: 0.75rem 1.5rem; background: #e0e0e0; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.2s; }
    .modality-tab:hover { background: #d0d0d0; }
    .modality-tab.active { background: #004892; color: white; }
    .modality-content { display: none; }
    .modality-content.active { display: block; }
    .content-box { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .workers-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 0.85rem; }
    .workers-table th, .workers-table td { padding: 0.5rem; text-align: left; border: 1px solid #ddd; }
    .workers-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    .workers-table tr:hover { background: #f5f5f5; }
    .skill-badge { display: inline-block; padding: 0.15rem 0.4rem; margin: 0.1rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600; }
    .skill-badge.active { background: #d4edda; color: #155724; }
    .skill-badge.passive { background: #fff3cd; color: #856404; }
    .skill-badge.excluded { background: #f8d7da; color: #721c24; }
    .edit-form { display: none; background: #f8f9fa; padding: 1.5rem; border: 2px solid #004892; border-radius: 4px; margin-bottom: 1rem; }
    .edit-form.active { display: block; }
    .edit-form h3 { margin-top: 0; color: #004892; }
    .edit-form-add { border-color: #28a745; }
    .edit-form-add h3 { color: #28a745; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 0.2rem; color: #333; font-size: 0.85rem; }
    .form-group input, .form-group select { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #004892; }
    .form-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .status-message { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
    .status-message.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .status-message.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .loading { text-align: center; padding: 2rem; color: #777; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section-header h2 { margin: 0; font-size: 1.2rem; }
    .skill-filter-bar { display: flex; gap: 0.3rem; margin-bottom: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; flex-wrap: wrap; align-items: center; }
    .skill-filter-bar label { font-weight: 600; color: #333; margin-right: 0.5rem; font-size: 0.85rem; }
    .filter-btn { padding: 0.3rem 0.6rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
    .filter-btn:hover { border-color: #004892; background: #f0f0f0; }
    .filter-btn.active { background: #004892; color: white; border-color: #004892; }
    .text-muted { color: #666; font-size: 0.85rem; }
    .table-empty-state { text-align: center; padding: 2rem; color: #777; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>RadIMO Cortex | Day Control</h1>
      <p style="font-size: 0.85rem; opacity: 0.9;">Same-day schedule adjustments - Changes take effect immediately</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('skill_roster_page') }}">Skill Matrix</a>
      <a href="{{ url_for('prep_next_day') }}">Prep Next Day</a>
      <a href="{{ url_for('upload_file') }}">Upload</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div class="warning-banner">
    <strong>⚠️ Live Editing:</strong> Changes on this page affect TODAY's schedule immediately.
    For tomorrow's schedule, use <a href="{{ url_for('prep_next_day') }}" style="color: #004892;">Prep Next Day</a>.
  </div>

  <div class="modality-tabs">
    {% for mod in modalities %}
    <button class="modality-tab{% if loop.first %} active{% endif %}" onclick="switchModality('{{ mod }}')">{{ mod|upper }}</button>
    {% endfor %}
  </div>

  <div class="content-box">
    <!-- Add New Worker Form -->
    <form id="addForm" class="edit-form edit-form-add" onsubmit="submitAdd(event)">
      <h3>➕ Add New Worker Entry</h3>
      <input type="hidden" id="addModality" name="modality">
      <div class="form-grid">
        <div class="form-group">
          <label>Person (PPL) *</label>
          <input type="text" name="person" placeholder="e.g., MU" required>
        </div>
        <div class="form-group">
          <label>Time Range *</label>
          <input type="text" name="time" placeholder="08:00-16:00" required>
        </div>
        <div class="form-group">
          <label>Modifier</label>
          <input type="number" name="modifier" step="0.1" value="1.0">
        </div>
        {% for skill in skills %}
        <div class="form-group">
          <label>{{ skill }}</label>
          <select name="{{ skill|lower }}">
            <option value="-1">-1 (Excluded)</option>
            <option value="0"{% if loop.index > 3 %} selected{% endif %}>0 (Passive)</option>
            <option value="1"{% if loop.index <= 2 %} selected{% endif %}>1 (Active)</option>
          </select>
        </div>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-success">Add Worker</button>
        <button type="button" class="btn btn-secondary" onclick="cancelAdd()">Cancel</button>
      </div>
    </form>

    <!-- Edit Form -->
    <form id="editForm" class="edit-form" onsubmit="submitEdit(event)">
      <h3>✏️ Edit Worker Entry</h3>
      <input type="hidden" id="editIndex" name="index">
      <input type="hidden" id="editModality" name="modality">
      <div class="form-grid">
        <div class="form-group">
          <label>Person (PPL)</label>
          <input type="text" id="editPerson" name="person" required>
        </div>
        <div class="form-group">
          <label>Time Range</label>
          <input type="text" id="editTime" name="time" placeholder="08:00-16:00" required>
        </div>
        <div class="form-group">
          <label>Modifier</label>
          <input type="number" id="editModifier" name="modifier" step="0.1" value="1.0">
        </div>
        {% for skill in skills %}
        <div class="form-group">
          <label>{{ skill }}</label>
          <select id="edit{{ skill }}" name="{{ skill|lower }}">
            <option value="-1">-1 (Excluded)</option>
            <option value="0">0 (Passive)</option>
            <option value="1">1 (Active)</option>
          </select>
        </div>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
      </div>
    </form>

    <!-- Modality Content Sections -->
    {% for mod in modalities %}
    <div id="{{ mod }}-content" class="modality-content{% if loop.first %} active{% endif %}">
      <div class="section-header">
        <h2>{{ mod|upper }} Workers</h2>
        <button class="btn btn-success btn-sm" onclick="showAddForm()">➕ Add Worker</button>
      </div>

      <div class="skill-filter-bar">
        <label>Filter:</label>
        <button class="filter-btn active" onclick="filterBySkill('{{ mod }}', 'all')">All</button>
        {% for skill in skills %}
        <button class="filter-btn" onclick="filterBySkill('{{ mod }}', '{{ skill }}')">{{ skill }}</button>
        {% endfor %}
      </div>

      <div id="{{ mod }}-loading" class="loading">Loading {{ mod|upper }} workers...</div>
      <div id="{{ mod }}-table-container" style="display: none;">
        <table class="workers-table">
          <thead>
            <tr>
              <th>Person</th>
              <th>Start</th>
              <th>End</th>
              <th>Dur</th>
              <th>Skills</th>
              <th>Mod</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="{{ mod }}-tbody"></tbody>
        </table>
      </div>
    </div>
    {% endfor %}

    <div id="statusMessage" class="status-message"></div>
  </div>

  <script>
    // Dynamic configuration from backend
    const SKILLS = {{ skills|tojson }};
    const MODALITIES = {{ modalities|tojson }};

    let currentModality = MODALITIES[0] || 'ct';
    let workersData = {};
    MODALITIES.forEach(m => workersData[m] = null);

    document.addEventListener('DOMContentLoaded', () => loadWorkers(currentModality));

    function switchModality(modality) {
      document.querySelectorAll('.modality-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.modality-content').forEach(c => c.classList.remove('active'));
      document.getElementById(modality + '-content').classList.add('active');
      currentModality = modality;
      if (!workersData[modality]) loadWorkers(modality);
      cancelEdit(); cancelAdd();
    }

    async function loadWorkers(modality) {
      try {
        const response = await fetch(`/api/live_edit/workers?modality=${modality}`);
        const data = await response.json();
        if (data.success) {
          workersData[modality] = data.workers;
          renderWorkersTable(modality);
          document.getElementById(`${modality}-loading`).style.display = 'none';
          document.getElementById(`${modality}-table-container`).style.display = 'block';
        } else {
          showStatus('Failed to load workers: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('Error loading workers: ' + error.message, 'error');
      }
    }

    function renderWorkersTable(modality) {
      const tbody = document.getElementById(`${modality}-tbody`);
      tbody.innerHTML = '';
      const workers = workersData[modality];
      if (!workers || workers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="table-empty-state">No workers scheduled</td></tr>';
        return;
      }

      workers.forEach((worker, index) => {
        const row = document.createElement('tr');
        const skillBadges = [];
        const activeSkills = [];

        SKILLS.forEach(skill => {
          const value = worker[skill];
          if (value === 1) {
            skillBadges.push(`<span class="skill-badge active">${skill}</span>`);
            activeSkills.push(skill);
          } else if (value === 0) {
            skillBadges.push(`<span class="skill-badge passive">${skill}</span>`);
          } else if (value === -1) {
            skillBadges.push(`<span class="skill-badge excluded">${skill}</span>`);
          }
        });

        row.setAttribute('data-active-skills', activeSkills.join(','));
        row.innerHTML = `
          <td><strong>${worker.PPL}</strong></td>
          <td>${worker.start_time || 'N/A'}</td>
          <td>${worker.end_time || 'N/A'}</td>
          <td>${worker.shift_duration ? worker.shift_duration.toFixed(1) + 'h' : 'N/A'}</td>
          <td>${skillBadges.join(' ')}</td>
          <td>${worker.Modifier || 1.0}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="editWorker('${modality}', ${index})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteWorker('${modality}', ${index})">Del</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function showAddForm() {
      cancelEdit();
      document.getElementById('addModality').value = currentModality;
      document.getElementById('addForm').reset();
      document.getElementById('addModality').value = currentModality;
      document.getElementById('addForm').classList.add('active');
      document.getElementById('addForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function cancelAdd() { document.getElementById('addForm').classList.remove('active'); }

    async function submitAdd(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const modality = formData.get('modality');
      formData.delete('index');
      try {
        const response = await fetch('/edit', { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
        if (response.ok) {
          showStatus('✅ Worker added successfully', 'success');
          await loadWorkers(modality);
          cancelAdd();
        } else {
          showStatus('Failed to add worker: ' + await response.text(), 'error');
        }
      } catch (error) {
        showStatus('Error adding worker: ' + error.message, 'error');
      }
    }

    function editWorker(modality, index) {
      const worker = workersData[modality][index];
      cancelAdd();
      const timeRange = (worker.start_time && worker.end_time) ? `${worker.start_time}-${worker.end_time}` : '';
      document.getElementById('editIndex').value = index;
      document.getElementById('editModality').value = modality;
      document.getElementById('editPerson').value = worker.PPL;
      document.getElementById('editTime').value = timeRange;
      document.getElementById('editModifier').value = worker.Modifier || 1.0;

      SKILLS.forEach(skill => {
        const el = document.getElementById('edit' + skill);
        if (el) el.value = worker[skill] !== undefined ? worker[skill] : 0;
      });

      document.getElementById('editForm').classList.add('active');
      document.getElementById('editForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function cancelEdit() { document.getElementById('editForm').classList.remove('active'); }

    async function submitEdit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const modality = formData.get('modality');
      try {
        const response = await fetch('/edit', { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
        if (response.ok) {
          showStatus('✅ Worker updated successfully', 'success');
          await loadWorkers(modality);
          cancelEdit();
        } else {
          showStatus('Failed to update worker: ' + await response.text(), 'error');
        }
      } catch (error) {
        showStatus('Error updating worker: ' + error.message, 'error');
      }
    }

    async function deleteWorker(modality, index) {
      if (!confirm('Delete this worker entry? This affects today\'s schedule immediately.')) return;
      try {
        const formData = new FormData();
        formData.append('index', index);
        formData.append('modality', modality);
        const response = await fetch('/delete', { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
        if (response.ok) {
          showStatus('✅ Worker deleted', 'success');
          await loadWorkers(modality);
        } else {
          showStatus('Failed to delete: ' + await response.text(), 'error');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    function showStatus(message, type) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status-message ' + type;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function filterBySkill(modality, skill) {
      const filterBar = document.querySelector(`#${modality}-content .skill-filter-bar`);
      filterBar.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      const tbody = document.getElementById(`${modality}-tbody`);
      tbody.querySelectorAll('tr').forEach(row => {
        if (row.querySelector('.table-empty-state')) return;
        if (skill === 'all') {
          row.style.display = '';
        } else {
          const activeSkills = row.getAttribute('data-active-skills') || '';
          row.style.display = activeSkills.includes(skill) ? '' : 'none';
        }
      });
    }
  </script>
</body>
</html>
