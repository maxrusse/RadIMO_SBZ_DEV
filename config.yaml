# =============================================================================
# RADIMO CORTEX CONFIGURATION
# =============================================================================
# This file defines all application settings including authentication,
# modalities, skills, load balancing, and CSV mapping rules.
# =============================================================================

# -----------------------------------------------------------------------------
# AUTHENTICATION
# -----------------------------------------------------------------------------
# admin_password: Password for admin pages (config, data management)
# access_password: Simple password for basic access protection (optional)
admin_password: change_pw_for_live

# Flask secret key for session management (required for production)
# Generate a secure random key: python -c "import secrets; print(secrets.token_hex(32))"
# secret_key: your_secure_random_key_here

# Basic access protection for non-admin pages (optional)
# Set to false to disable password protection entirely
access_protection_enabled: false
access_password: change_easy_pw

# Basic access protection for admin pages (optional)
# Set to false to disable password protection entirely
admin_access_protection_enabled: false

# -----------------------------------------------------------------------------
# TIMEZONE
# -----------------------------------------------------------------------------
# All date/time operations use this timezone
# Examples: Europe/Berlin, Europe/Zurich, America/New_York
timezone: Europe/Berlin

# =============================================================================
# MODALITIES
# =============================================================================
# Each modality represents an imaging type (CT, MR, X-ray, Mammo).
# Workers are assigned to modality-specific queues.
#
# Fields:
#   label: Display name in UI
#   nav_color: Navigation bar color (hex)
#   hover_color: Navigation hover state (hex)
#   background_color: Page background tint (hex)
#   factor: Workload multiplier (1.0 = baseline, higher = more weighted)
#   valid_skills: (optional) Whitelist - only show these skills for this modality
#   hidden_skills: (optional) Blacklist - hide these skills for this modality
# =============================================================================

modalities:
  ct:
    label: CT
    nav_color: '#2f5d8a'
    hover_color: '#24496b'
    background_color: '#e7f0f7'
    factor: 1.0
  mr:
    label: MR
    nav_color: '#5b4a7a'
    hover_color: '#47395f'
    background_color: '#f0eef6'
    factor: 1.2
  xray:
    label: X-ray
    nav_color: '#2f8c7a'
    hover_color: '#247060'
    background_color: '#e3f3ef'
    factor: 0.33
  mammo:
    label: Mammo
    nav_color: '#b45a7a'
    hover_color: '#8f4761'
    background_color: '#f7ecf1'
    factor: 0.5
    # Visibility filters (both optional, can combine):
    # - valid_skills: positive filter - only show these skills
    # - hidden_skills: negative filter - hide these skills
    valid_skills: [gyn, privat]  # Only gyn and privat for mammography

# =============================================================================
# SKILLS
# =============================================================================
# Skills represent medical specializations that workers can be assigned to.
# Each skill can be enabled/disabled per modality via skill_overrides in rules.
#
# Fields:
#   label: Display name in UI
#   button_color: Button background color (hex)
#   text_color: Button text color (hex)
#   weight: Workload weight multiplier (affects load balancing)
#   special: If true, skill requires special handling (subspecialty teams, styling)
#   display_order: Order in UI (lower = appears first)
#   slug: URL-safe identifier (lowercase, no special chars)
#   valid_modalities: (optional) Only show skill in these modalities
#   hidden_modalities: (optional) Hide skill in these modalities
# =============================================================================

skills:
  notfall:
    label: Notfall
    button_color: '#dc3545'
    text_color: '#ffffff'
    weight: 1.1
    special: false
    display_order: 0
    slug: notfall
  privat:
    label: Privat
    button_color: '#ffc107'
    text_color: '#333333'
    weight: 1.2
    special: false
    display_order: 1
    slug: privat
  gyn:
    label: Gyn
    button_color: '#b65c9a'
    text_color: '#ffffff'
    weight: 1.0
    special: true             # Subspecialty team
    display_order: 2
    slug: gyn
  paed:
    label: Päd
    button_color: '#5aa56a'
    text_color: '#ffffff'
    weight: 1.0
    special: true             # Subspecialty team
    display_order: 3
    slug: paed
  msk-haut:
    label: MSK/Haut
    button_color: '#7a6bb0'
    text_color: '#ffffff'
    weight: 0.8
    special: true             # Musculoskeletal & skin subspecialty
    display_order: 4
    slug: msk-haut
  abd-onco:
    label: Abd/Onco
    button_color: '#2b8fa1'
    text_color: '#ffffff'
    weight: 1.0
    special: true             # Abdominal imaging subspecialty
    display_order: 5
    slug: abd-onco
  card-thor:
    label: Card/Thor
    button_color: '#3d6aa8'
    text_color: '#ffffff'
    weight: 1.2
    special: true             # Cardio-thoracic subspecialty
    display_order: 6
    slug: card-thor
  uro:
    label: Uro
    button_color: '#7a5a4a'
    text_color: '#ffffff'
    weight: 1.0
    special: true             # urology subspecialty
    display_order: 7
    slug: uro
  kopf-hals:
    label: Kopf/Hals
    button_color: '#6b7a8c'
    text_color: '#ffffff'
    weight: 1.0
    special: true             # Head & neck subspecialty
    display_order: 8
    slug: kopf-hals

# =============================================================================
# SKILL×MODALITY WEIGHT OVERRIDES
# =============================================================================
# Override the default weight calculation (skill.weight × modality.factor)
# for specific skill×modality combinations.
# If not specified, falls back to: skill.weight × modality.factor
# =============================================================================

skill_modality_overrides:
  mr:
    card-thor: 1.8    # Cardiac MR weighted higher due to complexity

# =============================================================================
# NO OVERFLOW (STRICT MODE) COMBINATIONS
# =============================================================================
# List of Skill_Modality combinations where overflow to generalists is disabled.
# For these combos, the normal button acts like the [*] strict button - only
# specialists (skill=1 or 'w') will be assigned, never generalists (skill=0).
# Format: Skill_Modality (e.g., card-thor_ct, gyn_mr)
# =============================================================================

# Examples:
#   - card-thor_ct    # Cardiac CT - specialists only
#   - card-thor_mr    # Cardiac MR - specialists only
no_overflow:
  - privat_ct
  - privat_mr
  - privat_xray
  - privat_mammo

# =============================================================================
# SKILL VALUE DISPLAY COLORS
# =============================================================================
# These define how skill assignment values are displayed in the prep page table.
# Values: 1 (active), 0 (passive/fallback), -1 (excluded), 'w' (weighted/assisted)
# =============================================================================

skill_value_colors:
  active:     # skill = 1 (primary assignment - actively receives work)
    color: '#2f8c7a'
  passive:    # skill = 0 (fallback only - receives work if no active workers)
    color: '#8a8f98'
  excluded:   # skill = -1 (never assign - worker explicitly excluded)
    color: '#dc3545'
  weighted:   # skill = 'w' (assisted/weighted - receives less work, supervised)
    color: '#3d6aa8'

# =============================================================================
# UI THEME COLORS
# =============================================================================
# Colors for UI elements like tabs and status messages
# =============================================================================

ui_colors:
  today_tab: '#2f8c7a'        # Teal for "Change Today" tab
  tomorrow_tab: '#f2c94c'     # Golden for "Prep Tomorrow" tab
  success: '#2f8c7a'          # Success messages
  error: '#dc3545'            # Error messages

# =============================================================================
# WORKER LOAD MONITOR
# =============================================================================
# Configuration for the worker load monitoring page
# Color thresholds determine how worker loads are color-coded
# =============================================================================

worker_load_monitor:
  color_thresholds:
    mode: "absolute"          # "absolute" or "relative" - can toggle in UI
    absolute:
      low: 3.0                # Green below this weight
      high: 7.0               # Red above this weight (yellow in between)
    relative:
      low_pct: 33             # Green below 33% of max worker load
      high_pct: 66            # Red above 66% of max worker load
  default_view: "simple"      # "simple" or "advanced"

# =============================================================================
# SCHEDULER
# =============================================================================
# Background job timings for automated tasks
# =============================================================================

scheduler:
  daily_reset_time: "07:30"   # Time to move staged tomorrow -> live today
  auto_preload_time: 14       # Hour (0-23) to preload next workday from Master CSV

# =============================================================================
# BALANCER
# =============================================================================
# Load balancing configuration for distributing work across workers
# =============================================================================

balancer:
  enabled: true                              # Enable/disable load balancing
  min_assignments_per_skill: 3               # Minimum workers per skill before rebalancing
  imbalance_threshold_pct: 20                # Percentage threshold to trigger rebalancing
  disable_overflow_at_shift_start_minutes: 15  # Don't assign overflow in first X minutes
  disable_overflow_at_shift_end_minutes: 30    # Don't assign overflow in last X minutes
  default_w_modifier: 0.5                   # Default modifier for weighted ('w') skills

  # Hours counting for load balancing
  # Controls which entries count towards a worker's total hours in workload calculations
  hours_counting:
    shift_default: true   # type: "shift" entries count towards hours (default)
    gap_default: false    # type: "gap" entries don't count towards hours (default)

  # Quick break button settings (☕ button in prep page)
  # Creates a gap entry (all skills = -1) at current time
  # NOTE: gap_type must match a task with type: "gap" in medweb_mapping.rules
  quick_break:
    duration_minutes: 30          # Duration of the break in minutes
    gap_type: "Break"             # Gap type label - must match a gap task name below

  # Exclusion-based routing configuration
  # Define which workers to EXCLUDE when requesting each skill
  # Workers with excluded_skill=1 won't receive work for this skill
  #
  # Format examples:
  #   skill: []                    # No exclusions - anyone can receive
  #   skill: [skill1]              # Exclude workers with skill1=1
  #   skill: [skill1, skill2]      # Exclude workers with skill1=1 OR skill2=1
  exclude_skills:
    notfall: [gyn, paed]      # gyn and paed can not get emergency work
    privat: []       # No exclusions - anyone can get private patients
    gyn: []
    paed: []
    msk-haut: []
    abd-onco: []
    card-thor: []
    uro: []
    kopf-hals: []

# =============================================================================
# MEDWEB CSV MAPPING CONFIGURATION
# =============================================================================
#
# This section defines how CSV activity descriptions are mapped to shifts/gaps.
# Rules are evaluated in order; first match wins.
#
# SHIFT RULES:
#   - match: "Activity Name"           # Substring to match in CSV activity
#     type: "shift"
#     times:                           # REQUIRED: Day-specific times
#       default: "07:30-15:45"         # Default time (Mon-Thu unless overridden)
#       Montag: "08:00-16:00"          # Optional: Monday override
#       Freitag: "07:30-15:45"         # Optional: Friday override
#     skill_overrides:                 # REQUIRED: Defines skills & modalities
#       notfall_ct: 1                  # Skill_Modality: value (1, 0, -1, w)
#     modifier: 1.0                    # OPTIONAL: Workload modifier (0.5-1.5)
#     counts_for_hours: true           # OPTIONAL: Count in load balancing
#
# GAP RULES:
#   - match: "Board"                   # Substring to match
#     type: "gap"
#     times:                           # Day-specific times (arrays supported)
#       Montag:
#         - "10:00-11:00"
#     skill_overrides:
#       all: -1                        # Shortcut: exclude from all skills
#
# HOW DAY PLANS ARE BUILT:
#   1. Worker has multiple CSV entries → all matching rules are processed
#   2. Multiple shifts → later shift ENDS prior shift (no overlap)
#   3. Multiple gaps → all gaps are subtracted from shifts
#   4. Gaps ALWAYS WIN over shifts
#   5. Standalone gap with no shift → creates "unavailable" entry
#
# =============================================================================

vendor_mappings:
  medweb:
    # Column name mappings for this vendor's CSV format
    columns:
      date: "Datum"                           # Date column
      activity: "Beschreibung der Aktivität"  # Activity description (matched against rules)
      employee_name: "Name des Mitarbeiters"  # Worker name
      employee_code: "Code des Mitarbeiters"  # Worker ID code
      day_part: "Tageszeit"                   # Optional: VM/NM for time heuristics (TODO: future granular shifts)

    # Rules for mapping activities to shifts/gaps
    # Rules are evaluated in order; first match wins
    rules:

    # =========================================================================
    # DIAGNOSTIC LATE SHIFT - Covers all diagnostic modalities
    # =========================================================================
    # This shift handles afternoon/evening coverage across CT, MR, and X-ray.
    # All skills are active (=1) to provide full coverage during late hours.
    # =========================================================================

    - match: "OA CT"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        all: -1
        privat_ct: 1

    - match: "OA MR"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        all: -1
        privat_mr: 1

    - match: "OA Röntgen"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        all: -1
        privat_xray: 1

    - match: "OA Mammo"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        all: -1
        privat_mammo: 1

    - match: "Assistent Notfall"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        notfall_ct: 1
        notfall_mr: 1
        notfall_xray: 1
        notfall_mammo: 1

    - match: "UNZ Assistent"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        notfall_ct: 1
        notfall_mr: 1
        notfall_xray: 1
        notfall_mammo: 1

    - match: "Assistent Gyn"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        gyn_ct: 1
        gyn_mr: 1
        gyn_mammo: 1

    - match: "Gyn Assistent"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        gyn_ct: 1
        gyn_mr: 1
        gyn_mammo: 1

    - match: "Assistent Päd"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        paed_ct: 1
        paed_mr: 1
        paed_xray: 1

    - match: "Assistent KiKLi"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        paed_ct: 1
        paed_mr: 1
        paed_xray: 1

    - match: "Assistent AbdOnco"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        abd-onco_ct: 1
        abd-onco_mr: 1

    - match: "Assistent CardThor"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        card-thor_ct: 1
        card-thor_mr: 1

    - match: "Assistent Uro"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        uro_ct: 1
        uro_mr: 1

    - match: "Assistent KopfHals"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        kopf-hals_ct: 1
        kopf-hals_mr: 1

    - match: "FA/Fellow Notfall"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        notfall_ct: 1
        notfall_mr: 1
        notfall_xray: 1
        notfall_mammo: 1

    - match: "FA/Fellow Gyn"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        gyn_ct: 1
        gyn_mr: 1
        gyn_mammo: 1

    - match: "FA/Fellow Päd"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        paed_ct: 1
        paed_mr: 1
        paed_xray: 1

    - match: "FA/Fellow KiKLi"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        paed_ct: 1
        paed_mr: 1
        paed_xray: 1

    - match: "FA/Fellow MskHaut"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        msk-haut_ct: 1
        msk-haut_mr: 1
        msk-haut_xray: 1

    - match: "FA/Fellow AbdOnco"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        abd-onco_ct: 1
        abd-onco_mr: 1

    - match: "FA/Fellow CardThor"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        card-thor_ct: 1
        card-thor_mr: 1

    - match: "FA/Fellow Uro"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        uro_ct: 1
        uro_mr: 1

    - match: "FA/Fellow KopfHals"
      type: "shift"
      times:
        default: "07:30-15:45"
      skill_overrides:
        kopf-hals_ct: 1
        kopf-hals_mr: 1

    - match: "SBZ Spät Assistent"
      type: "shift"
      times:
        default: "11:30-19:45"
      skill_overrides:
        all: 1
        notfall_ct: -1
        notfall_xray: -1
        paed_ct: -1
        paed_mr: -1
        paed_xray: -1

    - match: "3. Dienst"
      label: "Röntgendienst"
      type: "shift"
      times:
        default: "11:30-19:45"
      skill_overrides:
        notfall_xray: 1

    # =========================================================================
    # ADMINISTRATIVE SHIFTS
    # =========================================================================
    # Shifts that don't count toward workload (administrative tasks)
    # =========================================================================

    # - match: "Aufklärung Shift"
    #   type: "shift"
    #   times:
    #     default: "07:30-15:45"
    #     Freitag: "07:30-15:45"
    #   label: "Aufklärung"
    #   counts_for_hours: false  # Administrative task - doesn't count for load
    #   skill_overrides:
    #     notfall_ct: 0          # Minimal skill assignment for modality tracking

    # =========================================================================
    # GAPS - Time exclusions (worker unavailable)
    # =========================================================================
    # Gaps define time periods when workers are unavailable for assignments.
    # Uses times field with skill_overrides: {all: -1} to exclude from all skills.
    #
    # Shortcuts for skill_overrides:
    #   all: -1        → all skill_modality combos = -1
    #   msk-haut: 1    → all msk-haut_* combos = 1
    #   ct: 1          → all *_ct combos = 1
    # =========================================================================

    - match: "SBZ Geräteassistenz"
      label: "Aufklärung"
      type: "gap"
      times:
        default: "07:30-15:45"
      skill_overrides:
        all: -1

    - match: "Mult. Myelom Board (Mo 15:30)"
      label: "Myelom-Board"
      type: "gap"
      times:
        Montag:
          - "13:30-16:30"
      skill_overrides:
        all: -1

    - match: "Medizin-Demo (Mo Nephro 13 Uhr/Di Gastro 14 Uhr/Mi Onko 12:30)"
      label: "Medizin-Demo"
      type: "gap"
      times:
        Montag:
          - "11:00-14:00"
        Dienstag:
          - "12:00-15:00"
        Mittwoch:
          - "10:30-13:30"
      skill_overrides:
        all: -1

    - match: "Rheuma-Demo (Do 13:30 Uhr, kl. Hörsaal Medizin)"
      label: "Rheuma-Demo"
      type: "gap"
      times:
        Donnerstag:
          - "11:30-14:30"
      skill_overrides:
        all: -1

    - match: "Emphysem-Board, Di 16:00 Uhr"
      label: "Emphysem-Board"
      type: "gap"
      times:
        Dienstag:
          - "14:00-17:00"
      skill_overrides:
        all: -1

    - match: "ILD-Board (Mi 15:00, 14-tägig)"
      label: "ILD-Board"
      type: "gap"
      times:
        Mittwoch:
          - "13:00-16:00"
      skill_overrides:
        all: -1

    - match: "Thoraxdemo ZTT (Di 14:30)"
      label: "Thoraxdemo"
      type: "gap"
      times:
        Dienstag:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "Kopf-Hals-Board (Mo 15:30)"
      label: "Kopf-Hals-Board"
      type: "gap"
      times:
        Montag:
          - "13:30-16:30"
      skill_overrides:
        all: -1

    - match: "CCCF-Leber (Mo 16:00)"
      label: "CCCF-Leber"
      type: "gap"
      times:
        Montag:
          - "14:00-17:00"
      skill_overrides:
        all: -1

    - match: "Lymphom-Board (Di 14:30)"
      label: "Lymphom-Board"
      type: "gap"
      times:
        Dienstag:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "Sarkom/Haut/Knochen-Board (Mi 14:30)"
      label: "Sarkom-Board"
      type: "gap"
      times:
        Mittwoch:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "Uro-Board (Do 14:30)"
      label: "Uro-Board"
      type: "gap"
      times:
        Donnerstag:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "Leukämie-Board (Do 14:30)"
      label: "Leukämie-Board"
      type: "gap"
      times:
        Donnerstag:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "ZGT/NET-Board (ehem. CCCF) (Do 07:30)"
      label: "ZGT"
      type: "gap"
      times:
        Mittwoch:
          - "09:00-15:45"
        Donnerstag:
          - "05:30-08:30"
      skill_overrides:
        all: -1

    - match: "ZGT Fallbesprechung (Mo 14:30)"
      label: "ZGT-Fallbesprechung"
      type: "gap"
      times:
        Montag:
          - "12:30-15:30"
      skill_overrides:
        all: -1

    - match: "Gyn Tumorboard (Di 14:30-16:00, Fr 07:30)"
      label: "Gyn-Tumorboard"
      type: "gap"
      times:
        Dienstag:
          - "12:30-15:30"
        Donnerstag:
          - "14:00-15:45"
        Freitag:
          - "05:30-08:30"
      skill_overrides:
        all: -1

    - match: "BB (Mi 16 Uhr, am letzten Mi des Monats)"
      label: "Beckenboden-Konferenz"
      type: "gap"
      times:
        Mittwoch:
          - "14:00-17:00"
      skill_overrides:
        all: -1

    - match: "TB: Immunvermittelte NW (Mi 14:00, jeden 1. Mittwoch im Monat)"
      label: "Immunvermittelte NW"
      type: "gap"
      times:
        Mittwoch:
          - "12:00-15:00"
      skill_overrides:
        all: -1

    - match: "Gefäßchir-Angiol-Kolloq (Mi 15:30)"
      label: "Gefäßchir-Kolloq"
      type: "gap"
      times:
        Mittwoch:
          - "13:30-16:30"
      skill_overrides:
        all: -1

    - match: "EmaH (Do 15:30 Uhr, Konf.raum 8)"
      label: "EmaH"
      type: "gap"
      times:
        Donnerstag:
          - "13:30-16:30"
      skill_overrides:
        all: -1

    - match: "VasMuT (Do 16 Uhr, Konf.raum 5)"
      label: "VasMuT"
      type: "gap"
      times:
        Donnerstag:
          - "14:00-17:00"
      skill_overrides:
        all: -1

    - match: "IPOK (Fr 13 Uhr, Konf.raum 5)"
      label: "IPOK"
      type: "gap"
      times:
        Freitag:
          - "11:00-14:00"
      skill_overrides:
        all: -1

    - match: "PRIS (Di 14:15 Uhr, 0_117 OA Büro)"
      label: "PRIS"
      type: "gap"
      times:
        Dienstag:
          - "12:15-15:15"
      skill_overrides:
        all: -1

    - match: "Nephr/urol. Kolloq. (Mi 15:30 Uhr, Konf.raum 6)"
      label: "Nephr-Kolloq"
      type: "gap"
      times:
        Mittwoch:
          - "13:30-16:30"
      skill_overrides:
        all: -1

    # =========================================================================
    # QUICK BREAK - Used by the ☕ quick break button (matches QUICK_BREAK.gap_type)
    # =========================================================================
    - match: "Break"
      label: "Break"
      type: "gap"
      times: {}
      skill_overrides:
        all: -1

    # =========================================================================
    # GENERIC GAP - For manual entries on prep page
    # =========================================================================
    # Empty times = won't auto-match from CSV, only manual selection in UI
    # =========================================================================
    - match: "[Gap]"
      label: "Gap"
      type: "gap"
      times: {}
      skill_overrides:
        all: -1
