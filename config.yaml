# =============================================================================
# RADIMO CORTEX CONFIGURATION
# =============================================================================
# This file defines all application settings including authentication,
# modalities, skills, load balancing, and CSV mapping rules.
# =============================================================================

# -----------------------------------------------------------------------------
# AUTHENTICATION
# -----------------------------------------------------------------------------
# admin_password: Password for admin pages (config, data management)
# access_password: Simple password for basic access protection (optional)
admin_password: change_pw_for_live

# Flask secret key for session management (required for production)
# Generate a secure random key: python -c "import secrets; print(secrets.token_hex(32))"
# secret_key: your_secure_random_key_here

# Basic access protection for non-admin pages (optional)
# Set to false to disable password protection entirely
access_protection_enabled: true
access_password: change_easy_pw

# -----------------------------------------------------------------------------
# TIMEZONE
# -----------------------------------------------------------------------------
# All date/time operations use this timezone
# Examples: Europe/Berlin, Europe/Zurich, America/New_York
timezone: Europe/Berlin

# =============================================================================
# MODALITIES
# =============================================================================
# Each modality represents an imaging type (CT, MR, X-ray, Mammo).
# Workers are assigned to modality-specific queues.
#
# Fields:
#   label: Display name in UI
#   nav_color: Navigation bar color (hex)
#   hover_color: Navigation hover state (hex)
#   background_color: Page background tint (hex)
#   factor: Workload multiplier (1.0 = baseline, higher = more weighted)
#   valid_skills: (optional) Whitelist - only show these skills for this modality
#   hidden_skills: (optional) Blacklist - hide these skills for this modality
# =============================================================================

modalities:
  ct:
    label: CT
    nav_color: '#1a5276'
    hover_color: '#153f5b'
    background_color: '#e6f2fa'
    factor: 1.0
  mr:
    label: MR
    nav_color: '#777777'
    hover_color: '#555555'
    background_color: '#f9f9f9'
    factor: 1.2
  xray:
    label: X-ray
    nav_color: '#239b56'
    hover_color: '#1d7a48'
    background_color: '#e0f2e9'
    factor: 0.33
  mammo:
    label: Mammo
    nav_color: '#e91e63'
    hover_color: '#c2185b'
    background_color: '#fce4ec'
    factor: 0.5
    # Visibility filters (both optional, can combine):
    # - valid_skills: positive filter - only show these skills
    # - hidden_skills: negative filter - hide these skills
    valid_skills: [Notfall, Gyn]  # Only emergency and gyn for mammography

# =============================================================================
# SKILLS
# =============================================================================
# Skills represent medical specializations that workers can be assigned to.
# Each skill can be enabled/disabled per modality via skill_overrides in rules.
#
# Fields:
#   label: Display name in UI
#   button_color: Button background color (hex)
#   text_color: Button text color (hex)
#   weight: Workload weight multiplier (affects load balancing)
#   optional: If true, skill can be toggled on/off by workers
#   special: If true, skill requires special handling (subspecialty teams)
#   display_order: Order in UI (lower = appears first)
#   slug: URL-safe identifier (lowercase, no special chars)
#   valid_modalities: (optional) Only show skill in these modalities
#   hidden_modalities: (optional) Hide skill in these modalities
# =============================================================================

skills:
  Notfall:
    label: Notfall
    button_color: '#dc3545'
    text_color: '#ffffff'
    weight: 1.1
    optional: false           # Always active - emergency cases mandatory
    special: false
    display_order: 0
    slug: notfall
  Privat:
    label: Privat
    button_color: '#ffc107'
    text_color: '#333333'
    weight: 1.2
    optional: true
    special: false
    hidden_modalities: [mammo]  # Mammography has no private patients
    display_order: 1
    slug: privat
  Gyn:
    label: Gyn
    button_color: '#e91e63'
    text_color: '#ffffff'
    weight: 1.0
    optional: true
    special: true             # Subspecialty team
    display_order: 2
    slug: gyn
  Päd:
    label: Päd
    button_color: '#4caf50'
    text_color: '#ffffff'
    weight: 1.0
    optional: true
    special: true             # Subspecialty team
    display_order: 3
    slug: paed
  MSK-Haut:
    label: MSK-Haut
    button_color: '#9c27b0'
    text_color: '#ffffff'
    weight: 0.8
    optional: true
    special: true             # Musculoskeletal & skin subspecialty
    display_order: 4
    slug: msk-haut
  Abdomen:
    label: Abdomen
    button_color: '#00bcd4'
    text_color: '#ffffff'
    weight: 1.0
    optional: true
    special: true             # Abdominal imaging subspecialty
    display_order: 5
    slug: abdomen
  CardThor:
    label: CardThor
    button_color: '#28a745'
    text_color: '#ffffff'
    weight: 1.2
    optional: true
    special: true             # Cardio-thoracic subspecialty
    display_order: 6
    slug: cardthor
  Uro:
    label: Uro
    button_color: '#795548'
    text_color: '#ffffff'
    weight: 1.0
    optional: true
    special: true             # Urology subspecialty
    display_order: 7
    slug: uro
  KopfHals:
    label: KopfHals
    button_color: '#607d8b'
    text_color: '#ffffff'
    weight: 1.0
    optional: true
    special: true             # Head & neck subspecialty
    display_order: 8
    slug: kopfhals

# =============================================================================
# SKILL×MODALITY WEIGHT OVERRIDES
# =============================================================================
# Override the default weight calculation (skill.weight × modality.factor)
# for specific skill×modality combinations.
# If not specified, falls back to: skill.weight × modality.factor
# =============================================================================

skill_modality_overrides:
  mr:
    CardThor: 1.8    # Cardiac MR weighted higher due to complexity

# =============================================================================
# SKILL VALUE DISPLAY COLORS
# =============================================================================
# These define how skill assignment values are displayed in the prep page table.
# Values: 1 (active), 0 (passive/fallback), -1 (excluded), 'w' (weighted/assisted)
# =============================================================================

skill_value_colors:
  active:     # skill = 1 (primary assignment - actively receives work)
    color: '#28a745'
    label: 'Active'
  passive:    # skill = 0 (fallback only - receives work if no active workers)
    color: '#6c757d'
    label: 'Passive'
  excluded:   # skill = -1 (never assign - worker explicitly excluded)
    color: '#dc3545'
    label: 'Excluded'
  weighted:   # skill = 'w' (assisted/weighted - receives less work, supervised)
    color: '#17a2b8'
    label: 'Weighted'

# =============================================================================
# UI THEME COLORS
# =============================================================================
# Colors for UI elements like tabs and status messages
# =============================================================================

ui_colors:
  today_tab: '#28a745'        # Green for "Change Today" tab
  tomorrow_tab: '#ffc107'     # Yellow for "Prep Tomorrow" tab
  success: '#28a745'          # Success messages
  error: '#dc3545'            # Error messages
  warning: '#ffc107'          # Warning messages
  info: '#17a2b8'             # Info messages

# =============================================================================
# SCHEDULER
# =============================================================================
# Background job timings for automated tasks
# =============================================================================

scheduler:
  daily_reset_time: "07:30"   # Time to move staged tomorrow -> live today
  auto_preload_time: 14       # Hour (0-23) to preload next workday from Master CSV

# =============================================================================
# BALANCER
# =============================================================================
# Load balancing configuration for distributing work across workers
# =============================================================================

balancer:
  enabled: true                              # Enable/disable load balancing
  min_assignments_per_skill: 3               # Minimum workers per skill before rebalancing
  imbalance_threshold_pct: 30                # Percentage threshold to trigger rebalancing
  allow_fallback_on_imbalance: true          # Allow fallback workers when imbalanced
  disable_overflow_at_shift_start_minutes: 15  # Don't assign overflow in first X minutes
  disable_overflow_at_shift_end_minutes: 30    # Don't assign overflow in last X minutes

  # Hours counting for load balancing
  # Controls which entries count towards a worker's total hours in workload calculations
  hours_counting:
    shift_default: true   # type: "shift" entries count towards hours (default)
    gap_default: false    # type: "gap" entries don't count towards hours (default)

  # Exclusion-based routing configuration
  # Define which workers to EXCLUDE when requesting each skill
  # Workers with excluded_skill=1 won't receive work for this skill
  #
  # Format examples:
  #   skill: []                    # No exclusions - anyone can receive
  #   skill: [skill1]              # Exclude workers with skill1=1
  #   skill: [skill1, skill2]      # Exclude workers with skill1=1 OR skill2=1
  exclude_skills:
    notfall: []      # No exclusions - anyone can get emergency work
    privat: []       # No exclusions - anyone can get private patients
    gyn: []
    paed: []
    msk-haut: []
    abdomen: []
    cardthor: []
    uro: []
    kopfhals: []

# =============================================================================
# MEDWEB CSV MAPPING CONFIGURATION
# =============================================================================
#
# This section defines how CSV activity descriptions are mapped to shifts/gaps.
# Rules are evaluated in order; first match wins.
#
# SHIFT RULES:
#   - match: "Activity Name"           # Substring to match in CSV activity
#     type: "shift"
#     times:                           # REQUIRED: Day-specific times
#       default: "07:00-15:00"         # Default time (Mon-Thu unless overridden)
#       Montag: "08:00-16:00"          # Optional: Monday override
#       Freitag: "07:00-13:00"         # Optional: Friday override
#     skill_overrides:                 # REQUIRED: Defines skills & modalities
#       Notfall_ct: 1                  # Skill_Modality: value (1, 0, -1, w)
#     modifier: 1.0                    # OPTIONAL: Workload modifier (0.5-1.5)
#     counts_for_hours: true           # OPTIONAL: Count in load balancing
#
# GAP RULES:
#   - match: "Board"                   # Substring to match
#     type: "gap"
#     times:                           # Day-specific times (arrays supported)
#       Montag:
#         - "10:00-11:00"
#     skill_overrides:
#       all: -1                        # Shortcut: exclude from all skills
#
# HOW DAY PLANS ARE BUILT:
#   1. Worker has multiple CSV entries → all matching rules are processed
#   2. Multiple shifts → later shift ENDS prior shift (no overlap)
#   3. Multiple gaps → all gaps are subtracted from shifts
#   4. Gaps ALWAYS WIN over shifts
#   5. Standalone gap with no shift → creates "unavailable" entry
#
# =============================================================================

vendor_mappings:
  medweb:
    # Column name mappings for this vendor's CSV format
    columns:
      date: "Datum"                           # Date column
      activity: "Beschreibung der Aktivität"  # Activity description (matched against rules)
      employee_name: "Name des Mitarbeiters"  # Worker name
      employee_code: "Code des Mitarbeiters"  # Worker ID code
      day_part: "Tageszeit"                   # Optional: VM/NM for time heuristics

    # Rules for mapping activities to shifts/gaps
    # Rules are evaluated in order; first match wins
    rules:

    # =========================================================================
    # DIAGNOSTIC LATE SHIFT - Covers all diagnostic modalities
    # =========================================================================
    # This shift handles afternoon/evening coverage across CT, MR, and X-ray.
    # All skills are active (=1) to provide full coverage during late hours.
    # =========================================================================

    - match: "Diag-Spätdienst"
      type: "shift"
      times:
        default: "13:00-21:00"    # Late shift: 1pm to 9pm
        Freitag: "13:00-19:00"    # Friday: shorter shift
      skill_overrides:
        # CT modality - all skills active
        Notfall_ct: 1
        Privat_ct: 1
        Gyn_ct: 1
        Päd_ct: 1
        MSK-Haut_ct: 1
        Abdomen_ct: 1
        CardThor_ct: 1
        Uro_ct: 1
        KopfHals_ct: 1
        # MR modality - all skills active
        Notfall_mr: 1
        Privat_mr: 1
        Gyn_mr: 1
        Päd_mr: 1
        MSK-Haut_mr: 1
        Abdomen_mr: 1
        CardThor_mr: 1
        Uro_mr: 1
        KopfHals_mr: 1
        # X-ray modality - all skills active
        Notfall_xray: 1
        Privat_xray: 1
        Gyn_xray: 1
        Päd_xray: 1
        MSK-Haut_xray: 1
        Abdomen_xray: 1
        CardThor_xray: 1
        Uro_xray: 1
        KopfHals_xray: 1

    # =========================================================================
    # COMMENTED OUT: Individual CT/MR Früh/Spätdienst rules
    # =========================================================================
    # These rules were replaced by the unified Diag-Spätdienst above.
    # Kept for reference in case individual modality shifts are needed again.
    # =========================================================================

    # # CT Shifts (INACTIVE)
    # - match: "CT Spätdienst"
    #   type: "shift"
    #   times:
    #     default: "13:00-21:00"
    #     Freitag: "13:00-19:00"
    #   skill_overrides:
    #     Notfall_ct: 1
    #     Privat_ct: 1
    #     MSK-Haut_ct: 0
    #     Abdomen_ct: 0
    #     CardThor_ct: 0
    #     Uro_ct: 0
    #     Gyn_ct: 0
    #     Päd_ct: 0
    #     KopfHals_ct: 0

    # - match: "CT Assistent"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   skill_overrides:
    #     Notfall_ct: 1
    #     Privat_ct: 1
    #     MSK-Haut_ct: 0
    #     Abdomen_ct: 0
    #     CardThor_ct: 0
    #     Uro_ct: 0
    #     Gyn_ct: 0
    #     Päd_ct: 0
    #     KopfHals_ct: 0

    # CT Private patients shift - specialized assignment
    - match: "CT Privatpatienten"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Privat_ct: 1         # Primary: private patients
        Notfall_ct: 0        # Fallback: can help with emergencies

    # # MR Shifts (INACTIVE)
    # - match: "MRT Spätdienst"
    #   type: "shift"
    #   times:
    #     default: "13:00-21:00"
    #     Freitag: "13:00-19:00"
    #   skill_overrides:
    #     Notfall_mr: 1
    #     Privat_mr: 1
    #     MSK-Haut_mr: 0
    #     Abdomen_mr: 0
    #     CardThor_mr: 0
    #     Uro_mr: 0
    #     Gyn_mr: 0
    #     Päd_mr: 0
    #     KopfHals_mr: 0

    # - match: "MR Assistent 1. Monat"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   modifier: 0.5  # Beginner: counts double toward their load
    #   skill_overrides:
    #     Notfall_mr: w      # Weighted: supervised, receives less work
    #     Privat_mr: 0       # Fallback only

    # - match: "MR Assistent"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   skill_overrides:
    #     Notfall_mr: 1
    #     Privat_mr: 1
    #     MSK-Haut_mr: 0
    #     Abdomen_mr: 0
    #     CardThor_mr: 0
    #     Uro_mr: 0
    #     Gyn_mr: 0
    #     Päd_mr: 0
    #     KopfHals_mr: 0

    # MR senior physician shift - full skill coverage
    - match: "MRT-OA"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Notfall_mr: 1
        Privat_mr: 1
        MSK-Haut_mr: 1
        Abdomen_mr: 1
        CardThor_mr: 1
        Uro_mr: 1
        Gyn_mr: 1
        Päd_mr: 1
        KopfHals_mr: 1

    # =========================================================================
    # X-RAY SHIFTS
    # =========================================================================
    # Conventional radiography (Chir = surgical X-ray station)
    # =========================================================================

    - match: "Chir Assistent"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Notfall_xray: 1
        Privat_xray: 1
        MSK-Haut_xray: 0     # Fallback for MSK
        Päd_xray: 0          # Fallback for pediatrics

    - match: "OA / FA Chir"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Notfall_xray: 1
        Privat_xray: 1
        MSK-Haut_xray: 1     # Full MSK coverage
        Päd_xray: 1          # Full pediatric coverage

    # =========================================================================
    # MAMMO SHIFTS
    # =========================================================================
    # Mammography - specialized breast imaging
    # Only Notfall and Gyn skills apply (no private patients)
    # =========================================================================

    - match: "Mammo Assistent"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Notfall_mammo: 1
        Gyn_mammo: 0         # Fallback for gynecology cases

    - match: "Mammo OA"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Notfall_mammo: 1
        Gyn_mammo: 1         # Full gyn coverage

    # =========================================================================
    # TEAM SHIFTS - Subspecialty teams across multiple modalities
    # =========================================================================
    # These shifts assign workers to specific subspecialty teams.
    # Team members handle cases for their specialty across relevant modalities.
    # =========================================================================

    # - match: "MSK-Haut Assistent"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   skill_overrides:
    #     MSK-Haut_ct: 1
    #     MSK-Haut_mr: 1
    #     MSK-Haut_xray: 1

    - match: "MSK-Haut Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        MSK-Haut_ct: 1
        MSK-Haut_mr: 1
        MSK-Haut_xray: 1

    # - match: "MSK-Haut Anfänger"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   modifier: 0.5          # Beginner: counts double toward their load
    #   skill_overrides:
    #     MSK-Haut_ct: w       # Weighted: supervised
    #     MSK-Haut_xray: w

    # - match: "CT Anfänger"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   modifier: 0.5          # Beginner: counts double toward their load
    #   skill_overrides:
    #     Notfall_ct: w        # Weighted: supervised, receives less work

    - match: "CardThor Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        CardThor_ct: 1       # Cardiac CT
        CardThor_mr: 1       # Cardiac MR

    - match: "Abdomen Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Abdomen_ct: 1
        Abdomen_mr: 1

    - match: "Uro Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Uro_ct: 1
        Uro_mr: 1

    - match: "Gyn Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Gyn_ct: 1
        Gyn_mr: 1

    - match: "Päd Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        Päd_ct: 1
        Päd_mr: 1
        Päd_xray: 1

    - match: "KopfHals Team"
      type: "shift"
      times:
        default: "07:00-15:00"
        Freitag: "07:00-13:00"
      skill_overrides:
        KopfHals_ct: 1
        KopfHals_mr: 1

    # =========================================================================
    # ADMINISTRATIVE SHIFTS
    # =========================================================================
    # Shifts that don't count toward workload (administrative tasks)
    # =========================================================================

    # - match: "Aufklärung Shift"
    #   type: "shift"
    #   times:
    #     default: "07:00-15:00"
    #     Freitag: "07:00-13:00"
    #   label: "Aufklärung"
    #   counts_for_hours: false  # Administrative task - doesn't count for load
    #   skill_overrides:
    #     Notfall_ct: 0          # Minimal skill assignment for modality tracking

    # =========================================================================
    # GAPS - Time exclusions (worker unavailable)
    # =========================================================================
    # Gaps define time periods when workers are unavailable for assignments.
    # Uses times field with skill_overrides: {all: -1} to exclude from all skills.
    #
    # Shortcuts for skill_overrides:
    #   all: -1        → all skill_modality combos = -1
    #   MSK-Haut: 1    → all MSK-Haut_* combos = 1
    #   ct: 1          → all *_ct combos = 1
    # =========================================================================

    - match: "Kopf-Hals-Board"
      type: "gap"
      times:
        Montag:
          - "15:30-17:00"      # Monday afternoon board meeting
      skill_overrides:
        all: -1                # Excluded from all assignments

    - match: "Board"
      type: "gap"
      times:
        Dienstag:
          - "15:00-17:00"      # Tuesday afternoon
        Mittwoch:
          - "10:00-12:00"      # Wednesday morning
        Donnerstag:
          - "14:00-16:00"      # Thursday afternoon
      skill_overrides:
        all: -1

    - match: "Besprechung"
      type: "gap"
      times:
        Montag:
          - "09:00-10:00"      # Monday morning meeting
        Mittwoch:
          - "14:00-15:00"      # Wednesday afternoon meeting
        Freitag:
          - "13:00-14:00"      # Friday lunch meeting
      skill_overrides:
        all: -1

    - match: "Fortbildung"
      type: "gap"
      times:
        Donnerstag:
          - "13:00-15:00"      # Thursday education/training
      skill_overrides:
        all: -1

    - match: "Aufklärung"
      type: "gap"
      times:
        Dienstag:
          - "10:00-11:00"      # Tuesday patient consultations
        Donnerstag:
          - "10:00-11:00"      # Thursday patient consultations
      skill_overrides:
        all: -1

    # =========================================================================
    # GENERIC GAP - For manual entries on prep page
    # =========================================================================
    # Empty times = won't auto-match from CSV, only manual selection in UI
    # =========================================================================
    - match: "[Gap]"
      type: "gap"
      times: {}
      skill_overrides:
        all: -1
